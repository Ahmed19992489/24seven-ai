<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>24Seven Admin Command - QA Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020617; color: #f1f5f9; font-family: 'Cairo', sans-serif; overflow-x: hidden; }
        .glass-card { background: rgba(15, 23, 42, 0.98); border: 1px solid #334155; backdrop-filter: blur(25px); border-radius: 20px; }
        .nav-link { @apply flex items-center gap-3 text-slate-400 hover:text-white hover:bg-slate-800 p-4 rounded-xl cursor-pointer transition-all; }
        .nav-link.active { @apply bg-red-600/20 text-red-500 border-r-4 border-red-600 shadow-lg shadow-red-900/20; }
        .stat-card { @apply p-6 rounded-2xl border border-slate-800 bg-slate-900/40 hover:border-red-500/50 transition-all; }
        .chat-bubble-admin { @apply bg-red-600 text-white rounded-2xl rounded-bl-none p-3 text-sm ml-auto mb-4 self-end shadow-md; }
        .chat-bubble-user { @apply bg-slate-800 text-slate-100 rounded-2xl rounded-br-none p-3 text-sm mr-auto mb-4 self-start border border-slate-700; }
        .ledger-row { @apply flex justify-between p-3 border-b border-slate-800 text-[10px] font-mono; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex text-right">

    <aside class="w-72 bg-slate-950 border-l border-slate-800 p-6 flex flex-col justify-between fixed h-full right-0 z-50 shadow-2xl">
        <div>
            <div class="flex items-center gap-3 mb-10">
                <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center shadow-lg shadow-red-900/40 animate-pulse">
                    <i class="fas fa-shield-alt text-white text-xl"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tighter text-white">GOD MODE <span class="text-red-600 text-xs">v9.3</span></h1>
            </div>
            <nav class="space-y-3">
                <div onclick="showSection('overview')" class="nav-link active" id="btn-overview"><i class="fas fa-chart-line w-6"></i> Ù†Ù…Ùˆ Ø§Ù„Ø´Ø±ÙƒØ©</div>
                <div onclick="showSection('users')" class="nav-link" id="btn-users"><i class="fas fa-user-shield w-6"></i> Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                <div onclick="showSection('payments')" class="nav-link" id="btn-payments"><i class="fas fa-vault w-6"></i> Ø§Ù„Ù…Ø§Ù„ÙŠØ© <span id="payment-badge" class="bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full">0</span></div>
                <div onclick="showSection('support')" class="nav-link" id="btn-support"><i class="fas fa-comments w-6"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</div>
                <div onclick="seedData()" class="nav-link text-yellow-500 hover:text-yellow-400 mt-10 border border-yellow-900/30 cursor-pointer"><i class="fas fa-sync-alt w-6"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…</div>
            </nav>
        </div>
        <div class="p-4 bg-slate-900/50 rounded-xl border border-slate-800 text-center">
            <span class="text-[10px] text-green-500 font-mono uppercase tracking-widest">Support: 01121748885</span>
        </div>
    </aside>

    <main class="flex-1 p-8 mr-72 text-right">
        <section id="overview" class="section-content animate-in fade-in duration-500">
            <h2 class="text-3xl font-bold mb-8 uppercase tracking-widest text-white">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ø³ØªØ®Ø¨Ø§Ø±Ø§Øª Ø§Ù„Ø³ÙˆÙ‚</h2>
            
            <div class="grid grid-cols-3 gap-6 mb-10 text-right">
                <div class="glass-card p-8 border-r-4 border-green-500 shadow-xl">
                    <p class="text-slate-500 text-xs font-bold mb-2 uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯ (Gross)</p>
                    <h3 id="stat-revenue" class="text-4xl font-bold text-green-500 tracking-tighter">0 EGP</h3>
                </div>
                
                <div class="glass-card p-8 border-r-4 border-blue-500 shadow-xl">
                    <p class="text-slate-500 text-xs font-bold mb-2 uppercase">ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Net Profit)</p>
                    <h3 id="stat-profit" class="text-4xl font-bold text-blue-500 tracking-tighter">0 EGP</h3>
                </div>

                <div class="glass-card p-8 border-r-4 border-red-500 shadow-xl">
                    <p class="text-slate-500 text-xs font-bold mb-2 uppercase tracking-widest">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Expenses)</p>
                    <h3 id="stat-expenses" class="text-4xl font-bold text-red-500 tracking-tighter">0 EGP</h3>
                </div>
            </div>

            <div class="glass-card p-6 mb-10 border border-red-900/30 bg-red-950/10">
                <h4 class="text-xs font-bold mb-4 text-red-400 uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-file-invoice-dollar ml-1"></i> ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„
                </h4>
                <div class="flex gap-4 items-center">
                    <input type="text" id="expense-label" class="flex-1 bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-xs outline-none focus:border-red-500 transition-all text-white" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ØµØ±ÙˆÙ (Ù…Ø«Ù„Ø§Ù‹: Ø¥Ø¹Ù„Ø§Ù†Ø§ØªØŒ Ø±ÙˆØ§ØªØ¨)">
                    <input type="number" id="expense-amount" class="w-40 bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-xs outline-none focus:border-red-500 transition-all text-white font-mono" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©">
                    <button onclick="addExpense()" class="bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-xl text-xs font-bold uppercase shadow-lg active:scale-95 transition-all flex items-center gap-2">
                        <i class="fas fa-minus-circle"></i> Ø®ØµÙ…
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                <div class="glass-card p-6 border border-pink-900/30 bg-pink-950/10">
                    <h4 class="text-xs font-bold mb-4 text-pink-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-ticket-alt ml-1"></i> Ù…ÙˆÙ„Ø¯ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª (Gift Cards)
                    </h4>
                    <div class="flex flex-col gap-4">
                        <div class="flex gap-2">
                            <input type="number" id="coupon-value" class="w-1/3 bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-xs outline-none focus:border-pink-500 text-white font-mono" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© (ØªÙˆÙƒÙ†)">
                            <input type="text" id="coupon-custom-code" class="flex-1 bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-xs outline-none focus:border-pink-500 text-white font-mono uppercase" placeholder="ÙƒÙˆØ¯ Ù…Ø®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        </div>
                        <button onclick="generateCoupon()" class="bg-pink-600 hover:bg-pink-500 text-white px-6 py-3 rounded-xl text-xs font-bold uppercase shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-magic"></i> Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ ÙÙˆØ±ÙŠ
                        </button>
                    </div>
                </div>
            
                <div class="glass-card p-6 border-slate-800 overflow-hidden flex flex-col">
                    <h4 class="text-xs font-bold mb-4 text-slate-400 uppercase tracking-widest flex items-center justify-between">
                        <span><i class="fas fa-barcode ml-2"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</span>
                        <button onclick="loadCoupons()" class="text-[9px] bg-slate-800 px-2 py-1 rounded hover:text-white"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«</button>
                    </h4>
                    <div class="flex-1 overflow-y-auto max-h-40 space-y-2 pr-2" id="coupons-list"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6 mb-10">
                <div class="glass-card p-6 border-slate-800">
                    <h4 class="text-xs font-bold mb-4 text-indigo-400 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-search-location ml-2"></i> Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø¨Ø­Ø«Ø§Ù‹</h4>
                    <div id="top-keywords-dashboard" class="space-y-2"></div>
                </div>
                <div class="glass-card p-6 border-slate-800">
                    <h4 class="text-xs font-bold mb-4 text-emerald-400 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-map-marked-alt ml-2"></i> Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹</h4>
                    <div id="top-locations-dashboard" class="space-y-2"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-6">
                <div class="stat-card text-center"><p class="text-slate-500 text-[10px] font-bold mb-1 uppercase tracking-widest">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p><h3 class="text-2xl font-bold text-white" id="stat-users">0</h3></div>
                <div class="stat-card text-center"><p class="text-slate-500 text-[10px] font-bold mb-1 uppercase tracking-widest">Ø§Ù„Ø¯Ø§ØªØ§</p><h3 class="text-2xl font-bold text-indigo-400" id="stat-leads">0</h3></div>
            </div>
        </section>

        <section id="users" class="section-content hidden">
            <h2 class="text-3xl font-bold mb-8 font-mono">CLIENT DATABASE & LEDGER</h2>
            <div class="glass-card overflow-hidden">
                <table class="w-full text-right">
                    <thead class="bg-slate-950 border-b border-slate-800 text-slate-500 text-xs uppercase font-bold">
                        <tr><th class="p-5">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-5">UID</th><th class="p-5">Ø§Ù„Ø±ØµÙŠØ¯</th><th class="p-5">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
                    </thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>
        </section>

        <section id="support" class="section-content hidden h-[calc(100vh-120px)]">
            <div class="grid grid-cols-12 gap-6 h-full">
                <div class="col-span-4 glass-card overflow-hidden flex flex-col border-red-900/20">
                    <div class="p-4 border-b border-slate-800 bg-slate-900 font-bold text-sm text-center uppercase tracking-widest text-white">Active Channels</div>
                    <div class="flex-1 overflow-y-auto" id="admin-chats-list"></div>
                </div>
                <div class="col-span-8 glass-card flex flex-col relative overflow-hidden shadow-2xl">
                    <div class="p-5 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center"><p id="active-chat-user" class="font-bold text-red-500 uppercase tracking-widest">Select Signal...</p></div>
                    <div class="flex-1 p-8 overflow-y-auto flex flex-col bg-slate-950/20" id="chat-messages-box"></div>
                    <div class="p-5 bg-slate-950 border-t border-slate-800 flex gap-4">
                        <input type="text" id="admin-msg-input" class="flex-1 bg-slate-900 border border-slate-800 rounded-xl px-6 py-4 outline-none focus:border-red-600 transition-all text-sm" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø¯ Ø§Ù„ØªÙƒØªÙŠÙƒÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„...">
                        <button onclick="sendAdminReply()" class="bg-red-600 hover:bg-red-500 w-20 rounded-xl flex items-center justify-center shadow-lg active:scale-95 transition-all"><i class="fas fa-paper-plane text-xl"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <section id="payments" class="section-content hidden">
            <h2 class="text-3xl font-bold mb-8 tracking-widest text-yellow-500 uppercase">Pending Transactions</h2>
            <div class="glass-card p-6">
                <table class="w-full text-right text-sm">
                    <thead><tr class="border-b border-slate-800 text-slate-500 text-[10px] uppercase font-bold"><th class="p-4 text-right">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-4 text-right">Ø§Ù„Ù…Ø¨Ù„Øº</th><th class="p-4 text-right">Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹</th><th class="p-4 text-center">Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th></tr></thead>
                    <tbody id="payments-table-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="user-modal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md hidden items-center justify-center p-10">
        <div class="glass-card w-full max-w-7xl h-[95vh] overflow-hidden flex flex-col border-red-600/30 relative shadow-2xl text-right">
            
            <div class="flex-1 overflow-y-auto p-10">
                <div class="flex gap-10 mb-8 h-[400px]">
                    <div class="w-1/4 border-l border-slate-800 pl-8 text-center flex flex-col">
                        <div class="w-24 h-24 bg-red-600 rounded-3xl mb-6 flex items-center justify-center text-4xl font-bold shadow-2xl mx-auto" id="modal-initials">--</div>
                        <h3 class="text-2xl font-bold mb-1 tracking-tight text-white" id="modal-user-name">--</h3>
                        <p class="text-red-500 text-sm mb-6 uppercase font-bold tracking-widest" id="modal-user-job">--</p>
                        
                        <div class="bg-blue-900/10 border border-blue-500/20 p-5 rounded-2xl mb-6 shadow-inner text-right flex-1">
                            <h4 class="text-[10px] font-bold text-blue-400 uppercase mb-3"><i class="fas fa-envelope-open-text ml-1"></i> Email Composer</h4>
                            <textarea id="marketing-email-msg" rows="3" class="w-full bg-slate-900 text-xs p-3 rounded-xl border border-slate-800 mb-3 outline-none focus:border-blue-500 text-slate-100" placeholder="Ø§ÙƒØªØ¨ Ø¹Ø±Ø¶Ø§Ù‹ Ù…Ø®ØµØµØ§Ù‹..."></textarea>
                            <button id="send-marketing-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-xl text-[10px] font-bold uppercase transition-all shadow-lg active:scale-95">Ø§Ø±Ø³Ù„ Ø¹Ø¨Ø± Gmail Ø§Ù„Ø¢Ù†</button>
                        </div>
                    </div>
                    
                    <div class="w-3/4 flex gap-8">
                        <div class="flex-1 flex flex-col text-right">
                            <h4 class="text-xl font-bold mb-6 text-indigo-400 border-b border-slate-800 pb-2 uppercase tracking-tighter font-mono">Search Behavior (RAG Feed)</h4>
                            <div id="modal-search-history" class="space-y-2 overflow-y-auto pr-2 flex-1"></div>
                        </div>
                        <div class="w-72 bg-slate-900/50 p-6 rounded-3xl border border-slate-800 flex flex-col shadow-inner text-right" dir="ltr">
                            <h4 class="text-lg font-bold mb-6 text-green-500 uppercase flex items-center gap-2 font-mono"><i class="fas fa-file-invoice-dollar text-sm"></i> Ledger</h4>
                            <div id="modal-financial-history" class="space-y-1 overflow-y-auto flex-1 text-right"></div>
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-800 pt-8 mt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-xl font-bold text-yellow-500 uppercase tracking-widest flex items-center gap-2">
                            <i class="fas fa-database"></i> Ø¢Ø®Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© (QA Check)
                        </h4>
                        <span class="text-[10px] text-slate-500 bg-slate-900 px-3 py-1 rounded-full border border-slate-800">ÙŠØ¹Ø±Ø¶ Ø¢Ø®Ø± 50 Ù†ØªÙŠØ¬Ø©</span>
                    </div>
                    
                    <div class="overflow-x-auto bg-slate-900/50 rounded-xl border border-slate-800">
                        <table class="w-full text-right text-xs">
                            <thead class="bg-slate-950 text-slate-400 uppercase font-bold border-b border-slate-800">
                                <tr>
                                    <th class="p-4">Ø§Ù„Ø´Ø±ÙƒØ©</th>
                                    <th class="p-4">Ø§Ù„Ù‡Ø§ØªÙ (Mobile First)</th>
                                    <th class="p-4">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
                                    <th class="p-4">ØµØ§Ù†Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø±</th>
                                    <th class="p-4 text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="modal-leads-body" class="divide-y divide-slate-800 text-slate-300">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <button onclick="closeUserModal()" class="p-5 bg-slate-900 hover:bg-red-600 transition-all font-bold uppercase text-[10px] tracking-[4px] border-t border-slate-800">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        const API_URL = "";
        let currentChatUserId = null;

        async function seedData() {
            if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù…ØŸ")) return;
            try {
                const res = await fetch(`${API_URL}/admin/seed-data`, {method: 'POST'});
                if(res.ok) {
                    alert("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                    loadStats(); loadUsers(); loadPayments();
                }
            } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
        }

        async function addExpense() {
            const label = document.getElementById('expense-label').value;
            const amount = document.getElementById('expense-amount').value;
            if(!label || !amount) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

            try {
                const res = await fetch(`${API_URL}/admin/add-expense`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ label: label, amount: parseFloat(amount) })
                });

                if(res.ok) {
                    document.getElementById('expense-label').value = '';
                    document.getElementById('expense-amount').value = '';
                    loadStats(); 
                    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ø¨Ø§Ø­");
                }
            } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/admin/stats`);
                const data = await res.json();
                
                const formatNum = (num) => (num || 0).toLocaleString();

                document.getElementById('stat-revenue').innerText = formatNum(data.revenue_estimated) + " EGP";
                document.getElementById('stat-profit').innerText = formatNum(data.net_profit) + " EGP";
                
                if(document.getElementById('stat-expenses')) {
                    document.getElementById('stat-expenses').innerText = (data.total_expenses_display || "0 EGP");
                }

                document.getElementById('stat-users').innerText = data.total_users || 0;
                document.getElementById('stat-leads').innerText = data.total_leads_captured || 0;

                if(data.top_keywords && data.top_keywords.length > 0) {
                    document.getElementById('top-keywords-dashboard').innerHTML = data.top_keywords.map(k => `
                        <div class="ledger-row bg-slate-950/50 rounded-lg border border-slate-800 px-3">
                            <span class="text-indigo-300 font-bold">${k.name}</span>
                            <span class="text-indigo-500">${k.count} Ø·Ù„Ø¨</span>
                        </div>
                    `).join('');
                }
                
                if(data.top_locations && data.top_locations.length > 0) {
                    document.getElementById('top-locations-dashboard').innerHTML = data.top_locations.map(l => `
                        <div class="ledger-row bg-slate-900/50 rounded-lg border border-slate-800 px-3">
                            <span class="text-emerald-400 font-bold">${l.name}</span>
                            <span class="text-emerald-600">${l.count} Ø¹Ù…ÙŠÙ„</span>
                        </div>
                    `).join('');
                }
            } catch(e) { console.error("Stats Error"); }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/admin/users`);
                const users = await res.json();
                if(users.length === 0) {
                    document.getElementById('users-table-body').innerHTML = '<tr><td colspan="4" class="text-center p-5 text-slate-600">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡..</td></tr>';
                    return;
                }
                document.getElementById('users-table-body').innerHTML = users.map(u => `
                    <tr class="border-b border-slate-900 hover:bg-slate-900 transition cursor-pointer text-right" onclick="openUserIntelligence(${u.id})">
                        <td class="p-5 font-bold text-sm text-slate-200">${u.email}</td>
                        <td class="p-5 font-mono text-xs text-slate-500">UID: ${u.id}</td>
                        <td class="p-5 text-green-500 font-bold font-mono text-sm">${u.credits}</td>
                        <td class="p-5 text-red-500 font-bold uppercase text-[9px] tracking-widest"><i class="fas fa-fingerprint ml-1"></i> Analyze</td>
                    </tr>
                `).join('');
            } catch(e) {}
        }

        async function openUserIntelligence(userId) {
            try {
                const res = await fetch(`${API_URL}/admin/user-details/${userId}`);
                const data = await res.json();
                document.getElementById('user-modal').classList.remove('hidden');
                document.getElementById('user-modal').classList.add('flex');
                
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                document.getElementById('modal-user-name').innerText = data.full_name;
                document.getElementById('modal-user-job').innerText = data.job_title;
                document.getElementById('modal-user-phone').innerText = data.phone;
                document.getElementById('modal-user-company').innerText = data.company_name;
                document.getElementById('modal-initials').innerText = (data.full_name[0] || 'U').toUpperCase();

                // ØªØ¹Ø¨Ø¦Ø© Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø­Ø«
                document.getElementById('modal-search-history').innerHTML = data.searches.map(s => `
                    <div class="ledger-row bg-slate-950 rounded-xl p-4 mb-2 border border-slate-800">
                        <span class="text-indigo-300 font-bold tracking-tighter text-right">ğŸ” ${s.keyword} <span class="text-slate-600 mx-2">@</span> ${s.location}</span>
                        <span class="text-slate-500 font-mono text-[9px]">${s.date}</span>
                    </div>
                `).join('') || '<p class="text-center opacity-30 mt-10">No Data</p>';

                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ
                document.getElementById('modal-financial-history').innerHTML = data.financials.map(f => `
                    <div class="ledger-row border-slate-800 items-center">
                        <span class="text-green-500 font-bold tracking-tighter">${f.amount} EGP</span>
                        <span class="text-[9px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-400 uppercase font-bold font-mono">${f.status}</span>
                    </div>
                `).join('') || '<p class="text-center opacity-30 mt-10">No Data</p>';

                // ğŸ”¥ ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© (QA Table)
                const leadsBody = document.getElementById('modal-leads-body');
                if (data.leads_preview && data.leads_preview.length > 0) {
                    leadsBody.innerHTML = data.leads_preview.map(l => `
                        <tr class="hover:bg-slate-800/50 transition">
                            <td class="p-4 font-bold text-white">${l.company || '-'}</td>
                            <td class="p-4 font-mono text-yellow-500" dir="ltr">${l.phone || '-'}</td>
                            <td class="p-4 text-blue-400">${l.email || '-'}</td>
                            <td class="p-4 text-slate-400">${l.decision_maker}</td>
                            <td class="p-4 text-center">
                                ${l.status === 'Valid' 
                                    ? '<span class="bg-green-900/50 text-green-400 px-2 py-1 rounded text-[10px] border border-green-500/30">Valid</span>' 
                                    : '<span class="text-slate-600">-</span>'}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    leadsBody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯.</td></tr>';
                }

                // Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
                document.getElementById('send-marketing-btn').onclick = () => {
                    const content = document.getElementById('marketing-email-msg').value;
                    window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${data.email}&su=ØªØ­Ø¯ÙŠØ« 24Seven&body=${encodeURIComponent(content)}`, '_blank');
                };

            } catch(e) { console.error(e); }
        }

        async function loadAdminChats() {
            try {
                const res = await fetch(`${API_URL}/chat/admin/all-chats`);
                const chats = await res.json();
                document.getElementById('admin-chats-list').innerHTML = chats.map(chat => `
                    <div onclick="selectActiveChat(${chat.user_id}, '${chat.user_email}')" 
                         class="p-5 border-b border-slate-900 hover:bg-slate-900 cursor-pointer transition-all ${currentChatUserId === chat.user_id ? 'bg-slate-900 border-l-4 border-red-600 shadow-inner' : ''}">
                        <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-200 text-left">${chat.user_email.split('@')[0]}</span><span class="text-[9px] text-slate-500 font-mono">${new Date(chat.timestamp).toLocaleTimeString('ar-EG')}</span></div>
                        <p class="text-[10px] text-slate-500 truncate text-left" dir="ltr">${chat.last_message}</p>
                    </div>
                `).join('');
            } catch(e) {}
        }

        async function selectActiveChat(userId, email) {
            currentChatUserId = userId;
            document.getElementById('active-chat-user').innerText = email;
            fetchMessages(userId);
        }

        async function fetchMessages(userId) {
            try {
                const res = await fetch(`${API_URL}/chat/history-admin/${userId}`);
                if (!res.ok) return;
                const msgs = await res.json();
                const box = document.getElementById('chat-messages-box');
                box.innerHTML = msgs.map(m => `<div class="${m.sender === 'admin' ? 'chat-bubble-admin' : 'chat-bubble-user'}">${m.message}<p class="text-[7px] mt-1 opacity-50 font-mono text-left">${new Date(m.created_at).toLocaleTimeString()}</p></div>`).join('');
                box.scrollTop = box.scrollHeight;
            } catch(e) {}
        }

        async function sendAdminReply() {
            const input = document.getElementById('admin-msg-input');
            const msg = input.value.trim();
            if(!msg || !currentChatUserId) return;
            await fetch(`${API_URL}/chat/admin/reply`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: currentChatUserId, message: msg })
            });
            input.value = ''; fetchMessages(currentChatUserId);
        }

        async function loadPayments() {
            try {
                const res = await fetch(`${API_URL}/admin/pending-payments`);
                const payments = await res.json();
                document.getElementById('payment-badge').innerText = payments.length;
                document.getElementById('payments-table-body').innerHTML = payments.map(p => `
                    <tr class="border-b border-slate-900 bg-slate-950/20 hover:bg-slate-900 transition text-right">
                        <td class="p-4 font-bold text-xs text-right">${p.user_email}</td>
                        <td class="p-4 text-green-500 font-bold font-mono text-lg text-right">${p.amount} EGP</td>
                        <td class="p-4 text-right"><a href="/static/uploads/${p.proof_image}" target="_blank" class="text-blue-400 underline uppercase text-[10px] font-bold tracking-widest">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥Ø«Ø¨Ø§Øª ğŸ“‚</a></td>
                        <td class="p-4 flex gap-2 justify-center"><button onclick="handlePayment(${p.id}, 'approve')" class="bg-green-600 px-4 py-2 rounded text-[10px] font-bold uppercase shadow-lg shadow-green-900/20 hover:bg-green-500 transition">Accept</button></td>
                    </tr>
                `).join('');
            } catch(e) {}
        }

        async function handlePayment(id, action) {
            await fetch(`${API_URL}/admin/process-payment`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ request_id: id, action: action })
            });
            loadPayments(); loadStats(); 
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª ---
        async function generateCoupon() {
            const value = document.getElementById('coupon-value').value;
            const code = document.getElementById('coupon-custom-code').value;
            if(!value) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†");
            try {
                const res = await fetch(`${API_URL}/admin/generate-coupon`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ value: parseInt(value), custom_code: code })
                });
                const data = await res.json();
                if(res.ok) {
                    alert(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„ÙƒÙˆØ¯: ${data.code}\nØ§Ù„Ù‚ÙŠÙ…Ø©: ${data.value}`);
                    document.getElementById('coupon-value').value = '';
                    document.getElementById('coupon-custom-code').value = '';
                    loadCoupons();
                } else { alert(data.detail || "Ø­Ø¯Ø« Ø®Ø·Ø£"); }
            } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
        }

        async function loadCoupons() {
            try {
                const res = await fetch(`${API_URL}/admin/active-coupons`);
                const coupons = await res.json();
                const container = document.getElementById('coupons-list');
                if(coupons.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-600 text-xs py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ù†Ø´Ø·Ø©</p>';
                    return;
                }
                container.innerHTML = coupons.map(c => `
                    <div class="flex justify-between items-center bg-slate-950/50 p-3 rounded-lg border border-slate-800 group">
                        <div class="flex items-center gap-3">
                            <span class="text-pink-500 font-mono font-bold text-sm select-all cursor-copy" onclick="navigator.clipboard.writeText('${c.code}'); alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯')">${c.code}</span>
                            <span class="text-[10px] bg-slate-800 text-slate-400 px-1.5 rounded">${c.created_at}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-green-400 font-bold text-xs">${c.value} T</span>
                            <button onclick="deleteCoupon('${c.code}')" class="text-slate-600 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            } catch(e) {}
        }

        async function deleteCoupon(code) {
            if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
            await fetch(`${API_URL}/admin/delete-coupon/${code}`, {method: 'DELETE'});
            loadCoupons();
        }

        function closeUserModal() { document.getElementById('user-modal').classList.add('hidden'); }
        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('btn-' + id)?.classList.add('active');
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadStats(); loadUsers(); loadPayments(); loadAdminChats(); loadCoupons();
            setInterval(loadStats, 10000); 
            setInterval(() => { if(currentChatUserId) selectActiveChat(currentChatUserId, document.getElementById('active-chat-user').innerText); }, 5000);
        });
    </script>
</body>
</html>