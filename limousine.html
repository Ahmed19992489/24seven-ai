<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>24Seven | Ø­Ø¬Ø² Ù„ÙŠÙ…ÙˆØ²ÙŠÙ† ÙØ§Ø®Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Outfit:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg-dark: #0f172a; --primary: #f59e0b; --card-bg: #1e293b; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-dark); color: #f8fafc; overflow-x: hidden; padding-bottom: 100px; }
        .font-num { font-family: 'Outfit', sans-serif; }
        .glass-card { background: var(--card-bg); border: 1px solid #334155; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .input-field { background: #0f172a; border: 1px solid #334155; border-radius: 12px; padding: 14px; width: 100%; color: white; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; border-top: 1px solid #334155; display: flex; justify-content: space-around; padding: 10px 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #64748b; font-size: 0.7rem; gap: 4px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
        .car-option { border: 2px solid transparent; background: #0f172a; padding: 10px; border-radius: 12px; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .car-option.active { border-color: var(--primary); background: rgba(245, 158, 11, 0.1); }
        .car-img { height: 50px; object-fit: contain; margin: 0 auto 5px; transition: transform 0.3s; }
        .car-option.active .car-img { transform: scale(1.1); }
        .trip-type-selector { display: flex; background: #0f172a; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .trip-type-btn { flex: 1; text-align: center; padding: 8px; border-radius: 8px; font-size: 0.8rem; color: #94a3b8; cursor: pointer; }
        .trip-type-btn.active { background: var(--primary); color: #000; font-weight: bold; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; background: #0f172a; padding: 10px; border-radius: 10px; border: 1px solid #334155; }
        .checkbox-wrapper input { accent-color: var(--primary); width: 16px; height: 16px; }
        #map { width: 100%; height: 200px; border-radius: 12px; display: none; margin-bottom: 15px; border: 1px solid #334155; }
        #loading-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 200; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s; }
        
        .trip-card { position: relative; overflow: hidden; transition: all 0.3s ease; }
        .trip-status-badge { position: absolute; top: 12px; left: 12px; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; }
        .status-pending { background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b40; }
        .status-approved { background: #22c55e20; color: #22c55e; border: 1px solid #22c55e40; }
        .status-driver_assigned { background: #3b82f620; color: #3b82f6; border: 1px solid #3b82f640; }
        .status-completed { background: #64748b20; color: #64748b; border: 1px solid #64748b40; }
    </style>
</head>
<body>

    <div id="loading-overlay"><i class="fas fa-circle-notch fa-spin text-4xl text-amber-500"></i></div>

    <header class="p-4 flex justify-between items-center bg-slate-900/90 backdrop-blur-md sticky top-0 z-40 border-b border-slate-800">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gradient-to-br from-amber-400 to-orange-600 rounded-lg flex items-center justify-center font-black text-slate-900">24</div>
            <h1 class="text-lg font-bold">Seven <span class="text-xs font-normal text-slate-400 block -mt-1">Limousine</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-left">
                <p id="header-user-name" class="text-xs font-bold leading-tight text-slate-300">Ø²Ø§Ø¦Ø±</p>
                <p class="text-[10px] text-amber-500 font-num font-bold"><span id="header-balance">0.00</span> EGP</p>
            </div>
            <button onclick="handleLogout()" class="w-8 h-8 rounded-full bg-red-500/10 border border-red-500/30 flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition">
                <i class="fas fa-sign-out-alt text-xs"></i>
            </button>
        </div>
    </header>

    <div class="p-4 min-h-screen">

        <div id="page-booking" class="page-content">
            <div class="glass-card p-5 mb-6 animate-fade-in-up">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                    <i class="fas fa-route text-amber-500"></i> Ø§Ø­Ø¬Ø² Ø±Ø­Ù„ØªÙƒ
                </h2>
                <div class="trip-type-selector">
                    <div onclick="setTripType('one-way')" class="trip-type-btn active" id="btn-one-way">Ø°Ù‡Ø§Ø¨ ÙÙ‚Ø·</div>
                    <div onclick="setTripType('round-same')" class="trip-type-btn" id="btn-round-same">Ø°Ù‡Ø§Ø¨ ÙˆØ¹ÙˆØ¯Ø© (Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…)</div>
                    <div onclick="setTripType('round-diff')" class="trip-type-btn" id="btn-round-diff">Ø£ÙŠØ§Ù… Ù…Ø®ØªÙ„ÙØ©</div>
                </div>
                <div id="map"></div>
                <div class="space-y-3 mb-4 relative">
                    <div class="absolute right-[22px] top-10 bottom-10 w-0.5 bg-slate-700 border-r border-dashed border-slate-600"></div>
                    <div class="relative"><i class="fas fa-circle-dot text-green-500 absolute top-4 right-4 text-xs z-10"></i><input id="pickup" type="text" placeholder="Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ (Ù…Ù†)" class="input-field pr-10"></div>
                    <div id="extra-point-div" class="relative hidden"><i class="fas fa-plus-circle text-blue-500 absolute top-4 right-4 text-xs z-10"></i><input id="extra-point" type="text" placeholder="Ù†Ù‚Ø·Ø© Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="input-field pr-10"></div>
                    <div class="relative"><i class="fas fa-location-dot text-amber-500 absolute top-4 right-4 text-xs z-10"></i><input id="dropoff" type="text" placeholder="Ø§Ù„ÙˆØ¬Ù‡Ø© (Ø¥Ù„Ù‰)" class="input-field pr-10"></div>
                    <label class="checkbox-wrapper w-fit"><input type="checkbox" id="opt-extra-point" onchange="toggleExtraPoint()"><span class="text-xs text-white">Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© ØªÙˆÙ‚Ù (+ ØªÙƒÙ„ÙØ© Ø¥Ø¶Ø§ÙÙŠØ©)</span></label>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="text-xs text-slate-400 mb-1 block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø°Ù‡Ø§Ø¨</label><input type="date" id="trip-date" class="input-field text-sm"></div>
                    <div><label class="text-xs text-slate-400 mb-1 block">ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø±Ùƒ</label><input type="time" id="trip-time" class="input-field text-sm"></div>
                </div>
                <div id="return-date-container" class="hidden mb-4 p-3 bg-slate-800 rounded-xl border border-amber-500/30">
                    <h3 class="text-xs font-bold text-amber-500 mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹ÙˆØ¯Ø©</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs text-slate-400 mb-1 block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø©</label><input type="date" id="return-date" class="input-field text-sm"></div>
                        <div><label class="text-xs text-slate-400 mb-1 block">ÙˆÙ‚Øª Ø§Ù„Ø¹ÙˆØ¯Ø©</label><input type="time" id="return-time" class="input-field text-sm"></div>
                    </div>
                </div>
                <p class="text-xs text-slate-400 font-bold mb-2">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</p>
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div onclick="selectCar('sedan')" class="car-option active" id="car-sedan"><img src="images/sedan.png" class="car-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3202/3202926.png'"><p class="text-center text-xs font-bold mt-1">Sedan</p><p class="text-center text-[10px] text-slate-400">4 Ø±ÙƒØ§Ø¨</p></div>
                    <div onclick="selectCar('suv')" class="car-option" id="car-suv"><img src="images/suv.png" class="car-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3202/3202022.png'"><p class="text-center text-xs font-bold mt-1">SUV</p><p class="text-center text-[10px] text-slate-400">Ø¹Ø§Ø¦Ù„ÙŠØ©</p></div>
                    <div onclick="selectCar('van')" class="car-option" id="car-van"><img src="images/van.png" class="car-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/75/75780.png'"><p class="text-center text-xs font-bold mt-1">Van</p><p class="text-center text-[10px] text-slate-400">14 Ø±Ø§ÙƒØ¨</p></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="text-xs text-slate-400 mb-1 block">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯</label><input type="number" id="pax-count" min="1" max="14" value="1" class="input-field text-center font-num"></div>
                    <div><label class="text-xs text-slate-400 mb-1 block">Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù†Ø·</label><input type="number" id="bags-count" min="0" max="10" value="0" class="input-field text-center font-num"></div>
                </div>
                <div class="flex gap-3 mb-6">
                    <label class="checkbox-wrapper flex-1"><input type="checkbox" id="opt-child-seat"><span class="text-xs text-white">ÙƒØ±Ø³ÙŠ Ø£Ø·ÙØ§Ù„</span></label>
                    <label class="checkbox-wrapper flex-1"><input type="checkbox" id="opt-wheelchair"><span class="text-xs text-white">ÙƒØ±Ø³ÙŠ Ù…ØªØ­Ø±Ùƒ</span></label>
                </div>
                <button onclick="calculateRealDistanceAndPrice()" id="calc-btn" class="w-full py-3.5 bg-gradient-to-r from-amber-500 to-orange-600 rounded-xl font-bold text-slate-900 shadow-lg active:scale-95 transition">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø­Ø¬Ø²</button>
            </div>
        </div>

        <div id="details-modal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
            <div class="bg-slate-800 rounded-2xl w-full max-w-md p-6 border border-slate-700 shadow-2xl overflow-y-auto max-h-[90vh]">
                <h3 class="text-xl font-bold text-white mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¬Ø²</h3>
                <div class="bg-slate-900 p-4 rounded-xl mb-4 border border-slate-700">
                    <div class="flex justify-between mb-2"><span class="text-slate-400 text-xs">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø­Ù„Ø©</span><span class="text-white text-xs font-bold" id="summ-type">--</span></div>
                    <div class="flex justify-between mb-2"><span class="text-slate-400 text-xs">Ø§Ù„Ù…Ø³Ø§ÙØ©</span><span class="text-white text-xs font-bold font-num" id="summ-dist">--</span></div>
                    <div class="flex justify-between border-t border-slate-700 pt-2 mt-2"><span class="text-slate-400 text-sm">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span class="text-amber-500 text-xl font-black font-num" id="summ-price">0 EGP</span></div>
                    <p class="text-[10px] text-slate-500 mt-1" id="summ-note"></p>
                </div>
                <h4 class="text-sm font-bold text-white mb-3">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„</h4>
                <div class="space-y-3">
                    <input type="text" id="guest-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" class="input-field">
                    <input type="tel" id="guest-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" class="input-field font-num">
                    <input type="tel" id="guest-whatsapp" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨" class="input-field font-num">
                    <div>
                        <label class="text-xs text-slate-400 mb-2 block">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                        <div class="grid grid-cols-3 gap-2">
                            <div onclick="selectPayment('cash')" class="pay-opt active p-3 rounded-xl bg-amber-500 text-slate-900 border border-slate-600 text-center cursor-pointer text-xs font-bold" id="pay-cash">ÙƒØ§Ø´</div>
                            <div onclick="selectPayment('instapay')" class="pay-opt p-3 rounded-xl bg-slate-900 text-white border border-slate-600 text-center cursor-pointer text-xs" id="pay-instapay">InstaPay</div>
                            <div onclick="selectPayment('wallet')" class="pay-opt p-3 rounded-xl bg-slate-900 text-white border border-slate-600 text-center cursor-pointer text-xs" id="pay-wallet">Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
                        </div>
                    </div>
                    <button onclick="confirmFinalBooking()" id="confirm-btn" class="w-full py-3 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-white mt-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
                    <button onclick="document.getElementById('details-modal').style.display='none'" class="w-full py-3 text-slate-400 font-bold text-sm">ØªØ±Ø§Ø¬Ø¹</button>
                </div>
            </div>
        </div>

        <div id="page-trips" class="page-content hidden">
            <h2 class="text-xl font-bold mb-4 text-white">Ø±Ø­Ù„Ø§ØªÙŠ</h2>
            <div id="trips-list" class="space-y-4 pb-20"></div>
        </div>

        <div id="page-wallet" class="page-content hidden">
            <div class="glass-card p-6 mb-6 bg-gradient-to-br from-slate-800 to-slate-900 border-amber-500/20 text-center">
                <p class="text-slate-400 mb-1">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                <h2 class="text-5xl font-num font-black text-white" id="wallet-page-balance">0.00</h2>
                <p class="text-amber-500 font-bold text-sm">EGP</p>
            </div>
            <div class="glass-card p-5">
                <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-bolt text-purple-500"></i> Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</h3>
                <div class="bg-white p-3 rounded-xl mb-4 flex items-center gap-3">
                    <img src="https://instapay.eg/wp-content/uploads/2022/04/instapay-logo-new.png" class="h-8 object-contain">
                    <div class="flex-1 text-right"><p class="text-slate-900 font-bold text-xs">InstaPay</p><p class="text-slate-600 font-num font-bold text-sm select-all">01121748885</p></div>
                </div>
                <div class="space-y-3">
                    <input type="number" id="deposit-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ„" class="input-field">
                    <input type="text" id="deposit-ref" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Reference ID)" class="input-field">
                    <button onclick="submitDeposit()" class="w-full py-3 bg-purple-600 rounded-xl font-bold text-white">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                </div>
            </div>
            <h3 class="font-bold mt-6 mb-3">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
            <div id="transactions-list" class="space-y-2"></div>
        </div>

        <div id="page-support" class="page-content hidden h-[80vh] flex flex-col items-center justify-center text-center">
             <div class="w-24 h-24 bg-green-500/10 rounded-full flex items-center justify-center mb-6"><i class="fab fa-whatsapp text-6xl text-green-500"></i></div>
             <a href="https://wa.me/201121748885" class="bg-green-600 text-white px-8 py-4 rounded-full font-bold text-lg mb-6">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a>
             <button onclick="handleLogout()" class="text-red-500 border border-red-500/30 px-6 py-2 rounded-lg text-sm font-bold hover:bg-red-500/10 transition"><i class="fas fa-sign-out-alt mr-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div onclick="switchTab('booking')" class="nav-item active" id="nav-booking"><i class="fas fa-car"></i><span>Ø­Ø¬Ø²</span></div>
        <div onclick="switchTab('trips')" class="nav-item" id="nav-trips"><i class="fas fa-list"></i><span>Ø±Ø­Ù„Ø§ØªÙŠ</span></div>
        <div onclick="switchTab('wallet')" class="nav-item" id="nav-wallet"><i class="fas fa-wallet"></i><span>Ø§Ù„Ù…Ø­ÙØ¸Ø©</span></div>
        <div onclick="switchTab('support')" class="nav-item" id="nav-support"><i class="fas fa-headset"></i><span>Ø§Ù„Ø¯Ø¹Ù…</span></div>
    </nav>

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-6 text-center">
         <div class="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-600 rounded-2xl flex items-center justify-center font-black text-3xl text-slate-900 mb-6 shadow-xl shadow-amber-500/20">24</div>
         <h1 class="text-3xl font-bold text-white mb-8">24Seven</h1>
         <button onclick="handleGoogleLogin()" class="w-full bg-white text-slate-900 font-bold py-3 rounded-xl mb-4 flex justify-center items-center gap-2"><img src="https://img.icons8.com/color/48/google-logo.png" class="w-5"> Google Login</button>
         <div class="w-full border-t border-slate-700 my-4 relative"><span class="absolute top-[-10px] left-1/2 -translate-x-1/2 bg-slate-900 px-2 text-xs text-slate-500">OR</span></div>
         <input id="login-email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="input-field mb-2 text-center">
         <input id="login-pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="input-field mb-4 text-center">
         <div class="flex gap-2 w-full">
            <button onclick="emailLogin()" class="flex-1 bg-amber-500 text-slate-900 font-bold py-3 rounded-xl">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="emailSignUp()" class="flex-1 bg-slate-800 text-slate-300 font-bold py-3 rounded-xl border border-slate-700">Ø¬Ø¯ÙŠØ¯</button>
         </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjFXAiKnbium5bHoR5uB4DftMB2vlpi4M&libraries=places&language=ar"></script>
    
    <script>
        // ==========================================
        // ğŸ› ï¸ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: ÙƒÙˆØ¯ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù‡Ø§Ø´ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ (Fix Double Hash)
        // ==========================================
        if (window.location.hash && window.location.hash.startsWith('##')) {
            window.location.hash = window.location.hash.substring(1);
        }

        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù…ÙŠÙ„
        const sb = supabase.createClient('https://qxtlsfmfetwcflbpvwuf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4dGxzZm1mZXR3Y2ZsYnB2d3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzMzODEsImV4cCI6MjA3ODAwOTM4MX0.FFGXNfx0FDA4FmJB1gVorNigs9nRoO4q1pCj2BOMDbU');
        
        let user = null;
        let pricingRules = [];
        let tripData = {type:'one-way', car:'sedan', pay:'cash', dist: 0, price: 0};
        let map, directionsService, directionsRenderer;

        // ==========================================
        // 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ
        // ==========================================
        
        async function checkSession() {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
            const { data: { session } } = await sb.auth.getSession();
            
            if (session) {
                console.log("âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ù„Ø³Ø©:", session.user.email);
                handleUserSignedIn(session);
            } else {
                // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠØ±Ø§Øª (Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
                sb.auth.onAuthStateChange((event, session) => {
                    console.log("ğŸ”” Auth Event:", event);
                    if (event === 'SIGNED_IN' && session) {
                        handleUserSignedIn(session);
                    } else if (event === 'SIGNED_OUT') {
                        showLoginScreen();
                    }
                });
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø§Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                if (!window.location.hash.includes('access_token')) {
                    showLoginScreen();
                }
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function handleUserSignedIn(session) {
            user = session.user;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
            document.getElementById('login-screen').style.display='none'; 
            document.getElementById('loading-overlay').style.display = 'flex';

            try {
                await ensureProfileExists();
                await loadData(); 
                initMaps(); 
                setupRealtime();
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.opacity = 0;
                    setTimeout(() => document.getElementById('loading-overlay').style.display='none', 300);
                }, 500);
            } catch (err) {
                console.error("Error init:", err);
            }
        }

        function showLoginScreen() {
            document.getElementById('loading-overlay').style.display='none';
            document.getElementById('login-screen').style.display='flex';
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        checkSession();

        // ==========================================
        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (ÙƒÙ…Ø§ Ù‡ÙŠ)
        // ==========================================

        async function ensureProfileExists() {
            const { data, error } = await sb.from('profiles').select('id').eq('id', user.id).single();
            if (!data) {
                await sb.from('profiles').insert([{ 
                    id: user.id, 
                    full_name: user.user_metadata.full_name || 'Ø¹Ù…ÙŠÙ„ Ø¬ÙˆØ¬Ù„', 
                    wallet_balance: 0 
                }]);
            }
        }

        function switchTab(id) {
            document.querySelectorAll('.page-content').forEach(e=>e.classList.add('hidden'));
            document.getElementById('page-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('nav-'+id).classList.add('active');
            if(id==='trips') loadTrips();
            if(id==='wallet') { loadWallet(); loadTransactions(); }
        }

        function setTripType(t) {
            tripData.type = t;
            document.querySelectorAll('.trip-type-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('btn-'+t).classList.add('active');
            document.getElementById('return-date-container').classList.toggle('hidden', t!=='round-diff');
        }

        function selectCar(c) {
            tripData.car = c;
            document.querySelectorAll('.car-option').forEach(e=>e.classList.remove('active'));
            document.getElementById('car-'+c).classList.add('active');
        }

        function selectPayment(m) {
            tripData.pay = m;
            document.querySelectorAll('.pay-opt').forEach(e=>{e.classList.remove('bg-amber-500','text-slate-900'); e.classList.add('bg-slate-900','text-white');});
            const el = document.getElementById('pay-'+m);
            el.classList.remove('bg-slate-900','text-white'); el.classList.add('bg-amber-500','text-slate-900');
        }

        function toggleExtraPoint() { document.getElementById('extra-point-div').classList.toggle('hidden'); }

        async function loadData() {
            const {data} = await sb.from('pricing_tiers').select('*'); if(data) pricingRules=data;
            const {data:p} = await sb.from('profiles').select('*').eq('id', user.id).single();
            if(p) {
                document.getElementById('header-user-name').innerText = p.full_name;
                document.getElementById('header-balance').innerText = p.wallet_balance;
                document.getElementById('wallet-page-balance').innerText = p.wallet_balance;
                document.getElementById('guest-name').value = p.full_name;
                document.getElementById('guest-phone').value = p.phone;
            }
        }

        function setupRealtime() {
            sb.channel('public:trips')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'trips', filter: 'user_id=eq.'+user.id }, (payload) => {
                  if(!document.getElementById('page-trips').classList.contains('hidden')) loadTrips();
              })
              .subscribe();
        }

        function initMaps() {
            try {
                new google.maps.places.Autocomplete(document.getElementById("pickup"));
                new google.maps.places.Autocomplete(document.getElementById("dropoff"));
                new google.maps.places.Autocomplete(document.getElementById("extra-point"));
                
                map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: 30.0444, lng: 31.2357 }, zoom: 10, disableDefaultUI: true,
                    styles: [ { "elementType": "geometry", "stylers": [{ "color": "#242f3e" }] }, { "elementType": "labels.text.stroke", "stylers": [{ "color": "#242f3e" }] }, { "elementType": "labels.text.fill", "stylers": [{ "color": "#746855" }] }, { "featureType": "road", "elementType": "geometry", "stylers": [{ "color": "#38414e" }] } ]
                });
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer();
                directionsRenderer.setMap(map);
            } catch (e) { console.log("Maps Error"); }
        }

        function calculateRealDistanceAndPrice() {
            const p = document.getElementById('pickup').value;
            const d = document.getElementById('dropoff').value;
            const date = document.getElementById('trip-date').value;
            const time = document.getElementById('trip-time').value;

            if(!p || !d || !date || !time) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            
            const btn = document.getElementById('calc-btn'); btn.innerText="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...";
            
            const mapDiv = document.getElementById('map');
            mapDiv.style.display = 'block'; 
            mapDiv.style.height = "200px";

            const waypoints = [];
            if(document.getElementById('opt-extra-point').checked && document.getElementById('extra-point').value) {
                waypoints.push({location: document.getElementById('extra-point').value, stopover: true});
            }

            const service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({origins:[p], destinations:[d], travelMode:'DRIVING'}, (res, status) => {
                if(status !== 'OK') { btn.innerText="Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø­Ø¬Ø²"; return alert("Ø®Ø·Ø£ Ù…Ù† Ø¬ÙˆØ¬Ù„: " + status); }
                const element = res.rows[0].elements[0];
                if (element.status !== 'OK') { btn.innerText="Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø­Ø¬Ø²"; return alert("ØªØ¹Ø°Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©: " + element.status); }

                const distKm = Math.ceil(element.distance.value / 1000);
                const carRules = pricingRules.filter(r => r.car_type === tripData.car);
                let rule = carRules.find(r => distKm >= r.min_km && distKm <= r.max_km);
                if (!rule && carRules.length > 0) rule = carRules.sort((a, b) => b.max_km - a.max_km)[0]; 
                
                let price = rule ? rule.base_price + (distKm * rule.price_per_km) : 150 + (distKm * 10);
                if(document.getElementById('opt-extra-point').checked) price += 100;
                if(tripData.type === 'round-same') price *= 1.75; 
                else if(tripData.type === 'round-diff') price *= 2; 

                tripData.price = Math.round(price);
                tripData.dist = distKm;
                tripData.date = date; tripData.time = time;
                tripData.returnDate = document.getElementById('return-date').value;
                tripData.returnTime = document.getElementById('return-time').value;

                directionsService.route({origin:p, destination:d, waypoints:waypoints, travelMode:'DRIVING'}, (rs, st) => {
                    if(st=='OK') {
                        directionsRenderer.setDirections(rs);
                        google.maps.event.trigger(map, 'resize');
                    }
                });

                document.getElementById('summ-dist').innerText = distKm + " km";
                document.getElementById('summ-price').innerText = tripData.price + " EGP";
                document.getElementById('details-modal').style.display = 'flex';
                btn.innerText="Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø­Ø¬Ø²";
            });
        }

        async function confirmFinalBooking() {
            const btn = document.getElementById('confirm-btn'); btn.disabled=true; btn.innerText="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø¬Ø²...";
            const walletBal = parseFloat(document.getElementById('header-balance').innerText);
            let payStatus = 'unpaid', deduct = 0;
            
            if(tripData.pay === 'wallet') {
                if(walletBal >= tripData.price) { deduct = tripData.price; payStatus = 'paid'; }
                else { alert("Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± ÙƒØ§ÙÙŠ!"); btn.disabled=false; btn.innerText="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²"; return; }
            }

            const name = document.getElementById('guest-name').value;
            const phone = document.getElementById('guest-phone').value;
            
            try { await sb.from('profiles').upsert({ id: user.id, full_name: name, phone: phone }); } catch (e) {}

            const note = `Ù†ÙˆØ¹: ${tripData.type} | Ø§Ù„Ø¯ÙØ¹: ${tripData.pay}\nğŸ“… ${tripData.date} - ${tripData.time}\nğŸ“± ${phone}`;
            let trip1Price = tripData.type === 'round-diff' ? tripData.price / 2 : tripData.price;
            
            const { error: tripError } = await sb.from('trips').insert([{
                user_id: user.id, pickup_location: document.getElementById('pickup').value, dropoff_location: document.getElementById('dropoff').value,
                distance_km: tripData.dist, estimated_price: trip1Price, car_type: tripData.car,
                status: 'pending', admin_notes: note, payment_status: payStatus
            }]);

            if (tripError) { alert("Ø®Ø·Ø£: " + tripError.message); btn.disabled=false; return; }

            if(tripData.type === 'round-diff') {
                await sb.from('trips').insert([{
                    user_id: user.id, pickup_location: document.getElementById('dropoff').value, dropoff_location: document.getElementById('pickup').value, 
                    distance_km: tripData.dist, estimated_price: trip1Price, car_type: tripData.car,
                    status: 'pending', admin_notes: note + " (Ø¹ÙˆØ¯Ø©)", payment_status: payStatus
                }]);
            }

            if(deduct > 0) await sb.from('profiles').update({wallet_balance: walletBal - deduct}).eq('id', user.id);
            alert("ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!"); location.reload();
        }

        async function loadTrips() {
             const { data: trips, error } = await sb
                .from('trips')
                .select('*, drivers:drivers!fk_trips_driver(*), cars:cars!fk_trips_car(*)') 
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

             if(error) {
                 const { data: simpleTrips } = await sb.from('trips').select('*').eq('user_id', user.id);
                 if(simpleTrips) renderTrips(simpleTrips);
                 return;
             }
             renderTrips(trips);
        }

        function renderTrips(trips) {
             document.getElementById('trips-list').innerHTML = trips ? trips.map(t => {
                let statusClass = 'status-pending';
                let statusText = 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
                let statusColor = 'text-amber-500';
                
                if(t.status === 'approved') { statusClass = 'status-approved'; statusText = 'Ù…Ù‚Ø¨ÙˆÙ„Ø©'; statusColor = 'text-green-500'; }
                if(t.status === 'driver_assigned') { statusClass = 'status-driver_assigned'; statusText = 'Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚'; statusColor = 'text-blue-500'; }
                if(t.status === 'completed') { statusClass = 'status-completed'; statusText = 'Ù…ÙƒØªÙ…Ù„Ø©'; statusColor = 'text-slate-400'; }

                let driverHtml = '';
                if(t.drivers && t.drivers.name) {
                    driverHtml = `
                    <div class="mt-4 pt-3 border-t border-slate-700">
                        <div class="flex items-center gap-3 bg-slate-800/50 p-3 rounded-xl">
                            <div class="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center text-xl">ğŸ‘¨â€âœˆï¸</div>
                            <div class="flex-1">
                                <p class="text-white font-bold text-sm">${t.drivers.name}</p>
                                <div class="flex gap-2 text-[10px] text-slate-400"><span>${t.cars?.model || 'Ø³ÙŠØ§Ø±Ø©'}</span> | <span class="font-num">${t.cars?.plate_number || '---'}</span></div>
                            </div>
                            <a href="tel:${t.drivers.phone}" class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center text-white"><i class="fas fa-phone"></i></a>
                            <a href="https://wa.me/20${t.drivers.phone}" class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white"><i class="fab fa-whatsapp"></i></a>
                        </div>
                    </div>`;
                }

                return `
                <div class="glass-card p-4 trip-card animate-fade-in-up mb-4 border border-slate-700/50">
                    <div class="flex justify-between items-start mb-2">
                        <span class="trip-status-badge ${statusClass}">${statusText}</span>
                        <span class="font-bold font-num ${statusColor}">${t.estimated_price} EGP</span>
                    </div>
                    <div class="mt-6"><p class="text-xs text-slate-300 font-bold">${t.pickup_location}</p><p class="text-xs text-slate-300 font-bold mt-2">${t.dropoff_location}</p></div>
                    ${driverHtml}
                </div>`;
             }).join('') : '';
        }

        async function loadWallet() {
            const {data} = await sb.from('profiles').select('wallet_balance').eq('id', user.id).single();
            if(data) document.getElementById('wallet-page-balance').innerText = data.wallet_balance.toFixed(2);
            loadTransactions();
        }

        async function loadTransactions() {
            const {data} = await sb.from('transactions').select('*').eq('user_id', user.id).order('created_at', {ascending:false});
            document.getElementById('transactions-list').innerHTML = data.map(tx=>`
                <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-700 text-xs">
                    <div><p class="text-white font-bold">${tx.amount} EGP</p><p class="text-slate-500">Ref: ${tx.reference_id}</p></div>
                    <span class="${tx.status==='approved'?'text-green-500':'text-amber-500'}">${tx.status}</span>
                </div>
            `).join('');
        }

        async function submitDeposit() {
            const amt = document.getElementById('deposit-amount').value, ref = document.getElementById('deposit-ref').value;
            if(!amt || !ref) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            await sb.from('transactions').insert([{user_id: user.id, amount: amt, reference_id: ref, status: 'pending'}]);
            alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); loadWallet();
        }

        async function handleGoogleLogin() { 
            await sb.auth.signInWithOAuth({ 
                provider: 'google', 
                options: { redirectTo: window.location.href } 
            }); 
        }
        
        async function emailLogin() { 
            const {error} = await sb.auth.signInWithPassword({
                email:document.getElementById('login-email').value, 
                password:document.getElementById('login-pass').value
            });
            if(error) alert(error.message);
        }

        async function emailSignUp() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            const { data, error } = await sb.auth.signUp({ email: email, password: password });
            
            if(error) {
                alert(error.message);
            } else if (data.session) {
                alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
            } else {
                alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªÙØ¹ÙŠÙ„ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.");
            }
        }

        async function handleLogout() { 
            await sb.auth.signOut(); 
            localStorage.clear();
            window.location.reload(); 
        }
    </script>
</body>
</html>