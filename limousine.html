<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>24Seven | Ø­Ø¬Ø² Ù„ÙŠÙ…ÙˆØ²ÙŠÙ† ÙØ§Ø®Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Outfit:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg-dark: #0f172a; --primary: #f59e0b; --card-bg: #1e293b; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-dark); color: #f8fafc; overflow-x: hidden; padding-bottom: 80px; }
        .font-num { font-family: 'Outfit', sans-serif; }
        .glass-card { background: var(--card-bg); border: 1px solid #334155; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .input-field { background: #0f172a; border: 1px solid #334155; border-radius: 12px; padding: 14px; width: 100%; color: white; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; border-top: 1px solid #334155; display: flex; justify-content: space-around; padding: 10px 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #64748b; font-size: 0.7rem; gap: 4px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
        .car-option { border: 2px solid transparent; background: #0f172a; padding: 10px; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .car-option.active { border-color: var(--primary); background: rgba(245, 158, 11, 0.1); }
        .car-img { height: 60px; object-fit: contain; margin: 0 auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }
        .trip-type-selector { display: flex; background: #0f172a; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .trip-type-btn { flex: 1; text-align: center; padding: 8px; border-radius: 8px; font-size: 0.8rem; color: #94a3b8; cursor: pointer; }
        .trip-type-btn.active { background: var(--primary); color: #000; font-weight: bold; }
        
        #map { height: 200px; width: 100%; border-radius: 12px; margin-top: 10px; }
    </style>
</head>
<body class="pb-20">

    <header class="p-5 flex justify-between items-center bg-slate-900/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-800">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gradient-to-br from-amber-400 to-orange-600 rounded-lg flex items-center justify-center font-black text-slate-900">24</div>
            <h1 class="text-lg font-bold">Seven <span class="text-xs font-normal text-slate-400 block -mt-1">Limousine</span></h1>
        </div>
        <div class="flex items-center gap-3" onclick="handleLogout()">
            <div class="text-left">
                <p id="header-user-name" class="text-sm font-bold leading-tight">Ø²Ø§Ø¦Ø±</p>
                <p id="header-balance" class="text-xs text-amber-500 font-num">0.00 EGP</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center overflow-hidden">
                <i class="fas fa-user text-slate-400"></i>
            </div>
        </div>
    </header>

    <div class="p-4 min-h-screen">

        <div id="page-booking" class="page-content">
            <div class="glass-card p-5 mb-6 animate-fade-in-up">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                    <i class="fas fa-route text-amber-500"></i> Ø§Ø­Ø¬Ø² Ø±Ø­Ù„ØªÙƒ
                </h2>

                <div class="trip-type-selector">
                    <div onclick="setTripType('one-way')" class="trip-type-btn active" id="btn-one-way">Ø°Ù‡Ø§Ø¨ ÙÙ‚Ø·</div>
                    <div onclick="setTripType('round')" class="trip-type-btn" id="btn-round">Ø°Ù‡Ø§Ø¨ ÙˆØ¹ÙˆØ¯Ø©</div>
                </div>

                <div class="space-y-3 mb-4 relative">
                    <div class="absolute right-[22px] top-10 bottom-10 w-0.5 bg-slate-700 border-r border-dashed border-slate-600"></div>
                    <div class="relative">
                        <i class="fas fa-circle-dot text-green-500 absolute top-4 right-4 text-xs z-10"></i>
                        <input id="pickup" type="text" placeholder="Ù…Ù† (Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚)" class="input-field pr-10">
                    </div>
                    <div class="relative">
                        <i class="fas fa-location-dot text-amber-500 absolute top-4 right-4 text-xs z-10"></i>
                        <input id="dropoff" type="text" placeholder="Ø¥Ù„Ù‰ (Ø§Ù„ÙˆØ¬Ù‡Ø©)" class="input-field pr-10">
                    </div>
                </div>

                <p class="text-xs text-slate-400 font-bold mb-2">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</p>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div onclick="selectCar('sedan')" class="car-option active" id="car-sedan">
                        <img src="https://raw.githubusercontent.com/google/fonts/main/ofl/cairo/OFL.txt" class="car-img" onerror="this.src='https://via.placeholder.com/100?text=Sedan'">
                        <p class="text-center text-xs font-bold mt-1">Sedan</p>
                        <p class="text-center text-[10px] text-slate-400">Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</p>
                    </div>
                    <div onclick="selectCar('suv')" class="car-option" id="car-suv">
                        <img src="https://raw.githubusercontent.com/google/fonts/main/ofl/cairo/OFL.txt" class="car-img" onerror="this.src='https://via.placeholder.com/100?text=SUV'">
                        <p class="text-center text-xs font-bold mt-1">SUV</p>
                        <p class="text-center text-[10px] text-slate-400">Ø¹Ø§Ø¦Ù„ÙŠØ©</p>
                    </div>
                    <div onclick="selectCar('van')" class="car-option" id="car-van">
                        <img src="https://raw.githubusercontent.com/google/fonts/main/ofl/cairo/OFL.txt" class="car-img" onerror="this.src='https://via.placeholder.com/100?text=Van'">
                        <p class="text-center text-xs font-bold mt-1">Van</p>
                        <p class="text-center text-[10px] text-slate-400">13 Ø±Ø§ÙƒØ¨</p>
                    </div>
                </div>

                <button onclick="calculatePrice()" id="calc-btn" class="w-full py-3.5 bg-gradient-to-r from-amber-500 to-orange-600 rounded-xl font-bold text-white shadow-lg active:scale-95 transition">
                    Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
                </button>
            </div>

            <div id="price-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex-col justify-end">
                <div class="bg-slate-800 rounded-t-3xl p-6 border-t border-slate-700 animate-slide-up">
                    <div class="w-12 h-1 bg-slate-600 rounded-full mx-auto mb-6"></div>
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <p class="text-slate-400 text-sm">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</p>
                            <h3 class="text-4xl font-num font-black text-white" id="modal-price">0</h3>
                            <span class="text-amber-500 font-bold text-sm">EGP</span>
                        </div>
                        <div class="text-left">
                            <p class="text-white font-bold text-lg" id="modal-dist">0 km</p>
                            <p class="text-xs text-slate-400" id="modal-type">Sedan</p>
                        </div>
                    </div>
                    <button onclick="showDetailsForm()" class="w-full py-4 bg-green-600 hover:bg-green-700 rounded-xl font-bold text-white text-lg shadow-lg mb-3">
                        Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø¬Ø² <i class="fas fa-arrow-left mr-2"></i>
                    </button>
                    <button onclick="document.getElementById('price-modal').style.display='none'" class="w-full py-3 text-slate-400 font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>

        <div id="page-trips" class="page-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Ø±Ø­Ù„Ø§ØªÙŠ</h2>
                <button onclick="loadTrips()" class="text-amber-500 text-sm"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
            </div>
            <div id="trips-list" class="space-y-4 pb-20">
                <div class="text-center py-20 text-slate-500">
                    <i class="fas fa-spinner fa-spin text-2xl"></i>
                    <p class="mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
        </div>

        <div id="page-wallet" class="page-content hidden">
            <div class="glass-card p-6 mb-6 bg-gradient-to-br from-slate-800 to-slate-900 border-amber-500/20">
                <p class="text-slate-400 mb-1">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                <h2 class="text-5xl font-num font-black text-white mb-2" id="wallet-balance-page">0.00</h2>
                <p class="text-amber-500 font-bold text-sm">Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ EGP</p>
            </div>

            <div class="glass-card p-5">
                <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-bolt text-purple-500"></i> Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</h3>
                <div class="bg-white p-3 rounded-xl mb-4 flex items-center gap-3">
                    <img src="https://instapay.eg/wp-content/uploads/2022/04/instapay-logo-new.png" class="h-8 object-contain">
                    <div class="flex-1 text-right">
                        <p class="text-slate-900 font-bold text-xs">InstaPay</p>
                        <p class="text-slate-600 font-num font-bold text-sm select-all">01121748885</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <input type="number" id="deposit-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ„" class="input-field">
                    <input type="text" id="deposit-ref" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Reference ID)" class="input-field">
                    <button onclick="submitDeposit()" class="w-full py-3 bg-purple-600 rounded-xl font-bold text-white">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                </div>
            </div>
            
            <h3 class="font-bold mt-6 mb-3">Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
            <div id="transactions-list" class="space-y-2"></div>
        </div>

        <div id="page-support" class="page-content hidden h-[80vh] flex flex-col items-center justify-center text-center">
            <div class="w-24 h-24 bg-green-500/10 rounded-full flex items-center justify-center mb-6">
                <i class="fab fa-whatsapp text-6xl text-green-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ 24/7</h2>
            <p class="text-slate-400 mb-8 max-w-xs mx-auto">ÙØ±ÙŠÙ‚ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø§Ù‡Ø² Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª. Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø« Ù…Ø¹Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©.</p>
            <a href="https://wa.me/201121748885" target="_blank" class="bg-[#25D366] text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg shadow-green-500/20 hover:scale-105 transition">
                ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¢Ù†
            </a>
        </div>

    </div>

    <nav class="bottom-nav">
        <div onclick="switchTab('booking')" class="nav-item active" id="nav-booking">
            <i class="fas fa-map-location-dot"></i><span>Ø­Ø¬Ø²</span>
        </div>
        <div onclick="switchTab('trips')" class="nav-item" id="nav-trips">
            <i class="fas fa-list-ul"></i><span>Ø±Ø­Ù„Ø§ØªÙŠ</span>
        </div>
        <div onclick="switchTab('wallet')" class="nav-item" id="nav-wallet">
            <i class="fas fa-wallet"></i><span>Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
        </div>
        <div onclick="switchTab('support')" class="nav-item" id="nav-support">
            <i class="fas fa-headset"></i><span>Ø§Ù„Ø¯Ø¹Ù…</span>
        </div>
    </nav>

    <div id="details-modal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl w-full max-w-md p-6 border border-slate-700 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-1">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©</h3>
            <p class="text-slate-400 text-xs mb-6">ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</p>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-slate-400 mb-1 block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø­Ù„Ø©</label>
                        <input type="date" id="book-date" class="input-field text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 mb-1 block">ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø±Ùƒ</label>
                        <input type="time" id="book-time" class="input-field text-sm">
                    </div>
                </div>
                
                <div>
                    <label class="text-xs text-slate-400 mb-1 block">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="guest-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§ÙØ±" class="input-field">
                </div>
                
                <div>
                    <label class="text-xs text-slate-400 mb-1 block">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="guest-phone" placeholder="01xxxxxxxxx" class="input-field font-num">
                </div>

                <div>
                    <label class="text-xs text-slate-400 mb-1 block">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù„ÙˆÙƒÙŠØ´Ù†)</label>
                    <input type="tel" id="guest-whatsapp" placeholder="01xxxxxxxxx" class="input-field font-num">
                </div>

                <div class="pt-4 flex gap-3">
                    <button onclick="confirmFinalBooking()" id="confirm-btn" class="flex-1 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-xl shadow-lg">ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ</button>
                    <button onclick="document.getElementById('details-modal').style.display='none'" class="flex-1 bg-slate-700 text-white font-bold py-3 rounded-xl">Ø±Ø¬ÙˆØ¹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-6 text-center">
        <div class="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-600 rounded-2xl flex items-center justify-center font-black text-3xl text-slate-900 mb-6 shadow-xl shadow-amber-500/20">24</div>
        <h1 class="text-3xl font-bold text-white mb-2">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ 24Seven</h1>
        <p class="text-slate-400 mb-8">ØªØ¬Ø±Ø¨Ø© Ù„ÙŠÙ…ÙˆØ²ÙŠÙ† ÙØ§Ø®Ø±Ø© ØªØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§</p>
        
        <div class="w-full max-w-sm space-y-3">
            <button onclick="handleGoogleLogin()" class="w-full bg-white text-slate-900 font-bold py-4 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-100 transition">
                <img src="https://img.icons8.com/color/48/google-logo.png" class="w-6 h-6"> Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google
            </button>
            <div class="relative py-4">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-700"></div></div>
                <div class="relative flex justify-center text-xs uppercase"><span class="bg-slate-900 px-2 text-slate-500">Ø£Ùˆ</span></div>
            </div>
            <input type="email" id="login-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="input-field text-center">
            <input type="password" id="login-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="input-field text-center">
            <div class="flex gap-3 mt-2">
                <button onclick="emailLogin()" class="flex-1 bg-slate-800 text-white font-bold py-3 rounded-xl border border-slate-700">Ø¯Ø®ÙˆÙ„</button>
                <button onclick="emailSignUp()" class="flex-1 bg-slate-800 text-slate-300 font-bold py-3 rounded-xl border border-slate-700">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFcMkqiLCX2z94HrIxmAnT47gpxIocB_E&libraries=places&language=ar"></script>
    
    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase ---
        const supabaseUrl = 'https://qxtlsfmfetwcflbpvwuf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4dGxzZm1mZXR3Y2ZsYnB2d3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzMzODEsImV4cCI6MjA3ODAwOTM4MX0.FFGXNfx0FDA4FmJB1gVorNigs9nRoO4q1pCj2BOMDbU';
        const sbClient = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let pricingRules = []; // Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        let tripData = {
            type: 'one-way',
            car: 'sedan',
            pickup: '',
            dropoff: '',
            dist: 0,
            price: 0
        };

        // --- 2. Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ---
        (async function init() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            const { data } = await sbClient.auth.getSession();
            if (data.session) {
                currentUser = data.session.user;
                document.getElementById('login-screen').style.display = 'none';
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                await loadPricingRules(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­
                await loadUserData();     // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                initMaps();               // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·
            }
        })();

        // --- 3. Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª ---
        function switchTab(id) {
            document.querySelectorAll('.page-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(`page-${id}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`nav-${id}`).classList.add('active');

            if(id === 'trips') loadTrips();
            if(id === 'wallet') { loadWallet(); loadTransactions(); }
        }

        // --- 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
        function setTripType(type) {
            tripData.type = type;
            document.querySelectorAll('.trip-type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');
        }

        function selectCar(type) {
            tripData.car = type;
            document.querySelectorAll('.car-option').forEach(e => e.classList.remove('active'));
            document.getElementById(`car-${type}`).classList.add('active');
        }

        async function loadPricingRules() {
            // Ø¬Ù„Ø¨ Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ù…Ù† Ø¬Ø¯ÙˆÙ„ pricing_tiers
            const { data, error } = await sbClient.from('pricing_tiers').select('*');
            if(!error && data) {
                pricingRules = data;
                console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ³Ø¹ÙŠØ±:", pricingRules);
            }
        }

        function calculatePrice() {
            const p = document.getElementById('pickup').value;
            const d = document.getElementById('dropoff').value;
            if(!p || !d) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„ÙˆØ¬Ù‡Ø©");

            const btn = document.getElementById('calc-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...';

            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ù†Ø³ØªØ®Ø¯Ù… Distance Matrix API)
            // Ù‡Ù†Ø§ Ø³Ù†Ø¶Ø¹ Ù…Ø³Ø§ÙØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø£Ùˆ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¯Ø®Ù„Ø§Øª Ø¨Ø³ÙŠØ·Ø©
            // Ù„Ø£Ù† Ø§Ù„Ù€ API Key Ù‚Ø¯ Ù„Ø§ ÙŠØ¯Ø¹Ù… Distance Matrix Ù…Ø¬Ø§Ù†Ø§Ù‹
            setTimeout(() => {
                const dist = Math.floor(Math.random() * 30) + 5; // Ù…Ø³Ø§ÙØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¨ÙŠÙ† 5 Ùˆ 35 ÙƒÙ… Ù„Ù„ØªØ¬Ø±Ø¨Ø©
                
                // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Ø§Ù„Ø´Ø±Ø§Ø¦Ø­)
                let finalPrice = 0;
                let foundRule = false;
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
                // Ù†Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø§Ø¹Ø¯Ø© ØªØ·Ø§Ø¨Ù‚ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ§Ù„Ù…Ø³Ø§ÙØ© ØªÙ‚Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ÙˆØ§Ù„Ø£Ù‚ØµÙ‰
                const rule = pricingRules.find(r => 
                    r.car_type === tripData.car && 
                    dist >= r.min_km && 
                    dist <= r.max_km
                );

                if (rule) {
                    // Ø§Ù„Ø³Ø¹Ø± = ÙØªØ­Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ + (Ø§Ù„Ù…Ø³Ø§ÙØ© * Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ)
                    finalPrice = Number(rule.base_price) + (dist * Number(rule.price_per_km));
                    foundRule = true;
                } else {
                    // Ø³Ø¹Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø´Ø±ÙŠØ­Ø© (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
                    finalPrice = 100 + (dist * 10); 
                }

                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø­Ù„Ø© Ø°Ù‡Ø§Ø¨ ÙˆØ¹ÙˆØ¯Ø©ØŒ Ù†Ø¶Ø§Ø¹Ù Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹ Ø®ØµÙ… Ø¨Ø³ÙŠØ·
                if(tripData.type === 'round') finalPrice = finalPrice * 1.8;

                tripData.pickup = p;
                tripData.dropoff = d;
                tripData.dist = dist;
                tripData.price = Math.round(finalPrice); // ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø³Ø¹Ø±

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                document.getElementById('modal-price').innerText = tripData.price;
                document.getElementById('modal-dist').innerText = dist + ' km';
                document.getElementById('modal-type').innerText = tripData.car.toUpperCase();
                
                document.getElementById('price-modal').style.display = 'flex';
                btn.innerHTML = 'Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ';
            }, 1000);
        }

        function showDetailsForm() {
            document.getElementById('price-modal').style.display = 'none';
            document.getElementById('details-modal').style.display = 'flex';
            
            // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª ÙÙŠ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
            if(currentUser && currentUser.user_metadata) {
                document.getElementById('guest-name').value = currentUser.user_metadata.full_name || '';
                document.getElementById('guest-phone').value = currentUser.user_metadata.phone || '';
            }
        }

        async function confirmFinalBooking() {
            const date = document.getElementById('book-date').value;
            const time = document.getElementById('book-time').value;
            const name = document.getElementById('guest-name').value;
            const phone = document.getElementById('guest-phone').value;
            const wa = document.getElementById('guest-whatsapp').value;

            if(!date || !time || !name || !phone) return alert("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø©");

            const btn = document.getElementById('confirm-btn');
            btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø¬Ø²...';
            btn.disabled = true;

            // 1. ØªØ­Ø¯ÙŠØ« Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù€ CRM)
            // Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¯Ø«Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ profiles
            const { error: profileError } = await sbClient.from('profiles').upsert({
                id: currentUser.id,
                full_name: name,
                phone: phone,
                updated_at: new Date()
            });

            if (profileError) console.error("Profile Update Error:", profileError);

            // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø¬Ø¯ÙˆÙ„ trips
            const adminNote = `ğŸ“… Ø§Ù„Ù…ÙˆØ¹Ø¯: ${date} Ø§Ù„Ø³Ø§Ø¹Ø© ${time} \nğŸ“± ÙˆØ§ØªØ³Ø§Ø¨: ${wa}`;

            const { error } = await sbClient.from('trips').insert([{
                user_id: currentUser.id,
                pickup_location: tripData.pickup,
                dropoff_location: tripData.dropoff,
                distance_km: tripData.dist,
                estimated_price: tripData.price, // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
                car_type: tripData.car,
                status: 'pending', // ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø¯Ù…Ù† ÙƒØ·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                admin_notes: adminNote,
                payment_status: 'unpaid'
            }]);

            if(error) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
                btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ';
                btn.disabled = false;
            } else {
                alert("ğŸ‰ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠÙ‚ÙˆÙ… ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ¹ÙŠÙŠÙ† Ø³Ø§Ø¦Ù‚.");
                document.getElementById('details-modal').style.display = 'none';
                switchTab('trips');
                btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ';
                btn.disabled = false;
            }
        }

        // --- 5. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø±Ø­Ù„Ø§ØªØŒ Ù…Ø­ÙØ¸Ø©) ---
        async function loadTrips() {
            const list = document.getElementById('trips-list');
            list.innerHTML = '<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-2xl text-amber-500"></i></div>';

            // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø©
            const { data: trips, error } = await sbClient
                .from('trips')
                .select('*, drivers:driver_id(name, phone), cars:car_id(model, plate_number, brand)')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            list.innerHTML = '';
            if(!trips || trips.length === 0) {
                list.innerHTML = '<div class="text-center py-20 text-slate-500"><i class="fas fa-road text-4xl mb-4 opacity-50"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p></div>';
                return;
            }

            trips.forEach(t => {
                let statusBadge = '';
                let driverSection = '';

                // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©
                if(t.status === 'pending') {
                    statusBadge = '<span class="bg-amber-500/10 text-amber-500 px-2 py-1 rounded text-[10px] font-bold">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>';
                    driverSection = `<div class="mt-3 pt-3 border-t border-slate-700 text-xs text-slate-400 flex items-center gap-2"><i class="fas fa-clock fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ¹ÙŠÙŠÙ† ÙƒØ§Ø¨ØªÙ†...</div>`;
                } else if(t.status === 'approved') {
                    statusBadge = '<span class="bg-blue-500/10 text-blue-500 px-2 py-1 rounded text-[10px] font-bold">Ù…Ù‚Ø¨ÙˆÙ„Ø© (Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°)</span>';
                    const drName = t.drivers?.name || 'ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†';
                    const carInfo = t.cars ? `${t.cars.brand} ${t.cars.model} (${t.cars.plate_number})` : 'Ø³ÙŠØ§Ø±Ø©';
                    driverSection = `
                        <div class="mt-3 pt-3 border-t border-slate-700 flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-user-tie text-slate-300"></i></div>
                            <div>
                                <p class="text-sm font-bold text-white">${drName}</p>
                                <p class="text-xs text-slate-400">${carInfo}</p>
                            </div>
                            <a href="tel:${t.drivers?.phone}" class="mr-auto w-8 h-8 rounded-full bg-green-600 flex items-center justify-center text-white"><i class="fas fa-phone"></i></a>
                        </div>
                    `;
                } else if(t.status === 'completed') {
                    statusBadge = '<span class="bg-green-500/10 text-green-500 px-2 py-1 rounded text-[10px] font-bold">Ù…ÙƒØªÙ…Ù„Ø©</span>';
                    driverSection = `<div class="mt-3 pt-3 border-t border-slate-700 text-xs text-green-500 flex items-center gap-2"><i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­</div>`;
                } else {
                    statusBadge = '<span class="bg-red-500/10 text-red-500 px-2 py-1 rounded text-[10px] font-bold">Ù…Ù„ØºØ§Ø©</span>';
                }

                list.innerHTML += `
                    <div class="glass-card p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-white text-lg">${t.dropoff_location.split(',')[0]}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-xs text-slate-400 mb-4"><i class="fas fa-map-marker-alt text-amber-500 ml-1"></i> Ù…Ù†: ${t.pickup_location.split(',')[0]}</p>
                        
                        <div class="flex justify-between items-center text-sm font-num">
                            <span class="text-slate-300">${new Date(t.created_at).toLocaleDateString()}</span>
                            <span class="text-amber-500 font-bold text-lg">${t.estimated_price} EGP</span>
                        </div>
                        ${driverSection}
                    </div>
                `;
            });
        }

        async function loadWallet() {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø¬Ø¯ÙˆÙ„ profiles
            const { data } = await sbClient.from('profiles').select('wallet_balance').eq('id', currentUser.id).single();
            const bal = (data?.wallet_balance || 0).toFixed(2);
            document.getElementById('wallet-balance-page').innerText = bal;
            document.getElementById('header-balance').innerText = bal + ' EGP';
        }

        async function submitDeposit() {
            const amount = document.getElementById('deposit-amount').value;
            const ref = document.getElementById('deposit-ref').value;
            if(!amount || !ref) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            
            await sbClient.from('transactions').insert([{user_id: currentUser.id, amount, reference_id: ref, status: 'pending'}]);
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");
            loadTransactions();
        }

        async function loadTransactions() {
            const list = document.getElementById('transactions-list');
            const { data } = await sbClient.from('transactions').select('*').eq('user_id', currentUser.id).order('created_at', {ascending: false});
            list.innerHTML = '';
            if(data) {
                data.forEach(tx => {
                    const color = tx.status === 'approved' ? 'text-green-500' : (tx.status === 'pending' ? 'text-amber-500' : 'text-red-500');
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-700">
                            <div>
                                <p class="text-white font-bold font-num">${tx.amount} EGP</p>
                                <p class="text-[10px] text-slate-500">Ref: ${tx.reference_id}</p>
                            </div>
                            <span class="text-xs font-bold ${color}">${tx.status}</span>
                        </div>
                    `;
                });
            }
        }

        async function loadUserData() {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù‡ÙŠØ¯Ø±
            const { data } = await sbClient.from('profiles').select('*').eq('id', currentUser.id).single();
            if(data && data.full_name) {
                document.getElementById('header-user-name').innerText = data.full_name;
            } else {
                document.getElementById('header-user-name').innerText = currentUser.email.split('@')[0];
            }
        }

        // --- 6. Ø§Ù„Ø®Ø±Ø§Ø¦Ø· ---
        function initMaps() {
            try {
                const p = new google.maps.places.Autocomplete(document.getElementById("pickup"));
                const d = new google.maps.places.Autocomplete(document.getElementById("dropoff"));
            } catch (e) { console.log("Google Maps not loaded yet"); }
        }

        // --- 7. Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth) ---
        async function handleGoogleLogin() { await sbClient.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.href } }); }
        
        async function emailLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            const { error } = await sbClient.auth.signInWithPassword({ email, password });
            if(error) alert(error.message); else location.reload();
        }
        
        async function emailSignUp() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            // Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŒ Ù†Ù†Ø´Ø¦ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const { data, error } = await sbClient.auth.signUp({ email, password });
            if(error) {
                alert(error.message);
            } else {
                alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„! ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.");
                // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù‡Ù†Ø§ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ù…Ø¨Ø¯Ø¦ÙŠ ÙÙŠ profiles Ø¥Ø°Ø§ Ø£Ø±Ø¯Ù†Ø§
            }
        }
        
        async function handleLogout() { await sbClient.auth.signOut(); location.reload(); }

    </script>
</body>
</html>