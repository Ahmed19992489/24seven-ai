<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24Seven | Admin ERP Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar-item {
            transition: all 0.2s;
            cursor: pointer;
            border-right: 3px solid transparent;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background-color: #e2e8f0;
            color: #0f172a;
            font-weight: bold;
            border-right-color: #f59e0b;
        }

        /* Ø§Ù„Ø¨Ø§Ù†Ù„ Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ */
        .glass-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .input-std {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
        }

        .input-std:focus {
            border-color: #f59e0b;
            ring: 2px solid #fcd34d;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* --- Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù…Ø© --- */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            display: block;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                right: -100%;
                width: 280px;
                height: 100%;
                z-index: 5000;
                transition: right 0.3s ease-in-out;
            }
            
            .sidebar.active { right: 0; }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 4000;
                backdrop-filter: blur(2px);
            }
            .overlay.active { display: block; }

            main {
                padding-top: 80px !important;
                padding-bottom: 80px !important;
            }
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden text-slate-800 bg-[#f8fafc]">

    <div class="md:hidden fixed top-0 left-0 right-0 h-16 bg-slate-900 text-white flex items-center justify-between px-4 z-[3000] shadow-lg">
        <h1 class="text-lg font-black">24<span class="text-amber-500">Seven</span> <span class="text-[10px] font-normal text-slate-400">ERP</span></h1>
        <button onclick="toggleSidebar()" class="text-2xl w-10 h-10 flex items-center justify-center rounded hover:bg-slate-800 focus:outline-none">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <div id="sidebar-overlay" class="overlay" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="sidebar w-64 bg-white border-l border-slate-200 flex flex-col shadow-xl shrink-0 md:relative md:right-0">
        <div class="h-16 flex items-center justify-center border-b border-slate-100 bg-slate-900 text-white hidden md:flex">
            <h1 class="text-xl font-black">24<span class="text-amber-500">Seven</span> <span class="text-[10px] font-normal text-slate-400">ERP</span></h1>
        </div>

        <div class="md:hidden p-4 flex justify-end">
            <button onclick="toggleSidebar()" class="text-slate-500"><i class="fas fa-times text-xl"></i></button>
        </div>

        <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
            <div onclick="showPage('dashboard')" id="nav-dashboard" class="sidebar-item active p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-chart-line w-5 text-center text-blue-600"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
            </div>

            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>
            <div onclick="showPage('operations')" id="nav-operations" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-satellite-dish w-5 text-center text-amber-600"></i> ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
            </div>
            <div onclick="showPage('crm')" id="nav-crm" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-users w-5 text-center text-purple-600"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)
            </div>

            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØ§Ø±Ø¯</p>
            <div onclick="showPage('finance')" id="nav-finance" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-wallet w-5 text-center text-green-600"></i> Ø§Ù„Ø®Ø²ÙŠÙ†Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸
            </div>
            <div onclick="showPage('fleet')" id="nav-fleet" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-car w-5 text-center text-slate-600"></i> Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„ÙƒØ¨Ø§ØªÙ†
            </div>

            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
            <div onclick="showPage('pricing')" id="nav-pricing" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-tags w-5 text-center text-gray-600"></i> Ø§Ù„ØªØ³Ø¹ÙŠØ±
            </div>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-4 md:p-6 w-full h-full relative">

        <div id="page-dashboard" class="page-section">
            <h2 class="text-2xl font-bold mb-6">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="glass-panel p-6 border-b-4 border-blue-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª</p>
                    <h3 class="text-3xl font-black mt-2" id="kpi-total">--</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-green-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p>
                    <h3 class="text-3xl font-black mt-2 text-green-600 dir-ltr" id="kpi-main-vault">0 EGP</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-amber-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">Ø®Ø²Ù†Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</p>
                    <h3 class="text-3xl font-black mt-2 text-amber-600 dir-ltr" id="kpi-maint-vault">0 EGP</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-purple-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">Ø®Ø²Ù†Ø© Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</p>
                    <h3 class="text-3xl font-black mt-2 text-purple-600 dir-ltr" id="kpi-cars-salary">0 EGP</h3>
                </div>
            </div>
            
            <div class="glass-panel p-6 mb-8">
                <h3 class="font-bold mb-4">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
                <div class="w-full h-64">
                    <canvas id="tripsChart"></canvas>
                </div>
            </div>
        </div>

        <div id="page-operations" class="page-section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold">ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="loadOperations()" class="bg-white border px-4 py-2 rounded-lg hover:bg-slate-100 font-bold text-sm flex-1 md:flex-none">
                        <i class="fas fa-sync-alt mr-2"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                    <button onclick="document.getElementById('manual-trip-modal').style.display='flex'" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-bold text-sm flex-1 md:flex-none shadow-lg">
                        <i class="fas fa-plus mr-2"></i> Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠ
                    </button>
                </div>
            </div>
            
            <div class="glass-panel overflow-hidden">
                <div class="table-responsive">
                    <table class="w-full text-right text-sm whitespace-nowrap">
                        <thead class="bg-slate-100 text-slate-600 font-bold">
                            <tr>
                                <th class="p-4">#</th>
                                <th class="p-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th class="p-4">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</th>
                                <th class="p-4">Ø§Ù„Ù…Ø³Ø§Ø±</th>
                                <th class="p-4">Ø§Ù„Ù…Ø±ÙƒØ¨Ø©/Ø§Ù„ÙƒØ§Ø¨ØªÙ†</th>
                                <th class="p-4">Ø§Ù„Ø³Ø¹Ø±</th>
                                <th class="p-4">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th class="p-4">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="ops-table" class="divide-y divide-slate-100 font-medium"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-finance" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="vaults-grid"></div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-panel p-6">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-money-bill-wave text-green-500"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† (InstaPay)
                    </h3>
                    <div id="deposit-requests-list" class="space-y-3 max-h-80 overflow-y-auto">
                        <p class="text-center text-slate-400 py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>
                </div>

                <div class="glass-panel p-6 border-t-4 border-red-500">
                    <h3 class="font-bold mb-4 text-red-600">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</h3>
                    <div class="space-y-3">
                        <input type="text" id="gen-exp-title" placeholder="Ø¨Ù†Ø¯ Ø§Ù„ØµØ±Ù" class="input-std">
                        <div class="flex gap-2">
                            <input type="number" id="gen-exp-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="input-std">
                            <select id="gen-exp-vault" class="input-std bg-slate-50">
                                <option value="main">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>
                            </select>
                        </div>
                        <button onclick="addGeneralExpense()" class="w-full bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 btn-action">ØªØ³Ø¬ÙŠÙ„</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-fleet" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</h2>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-auto lg:h-[calc(100vh-150px)]">
                <div class="glass-panel p-4 overflow-y-auto col-span-1 h-96 lg:h-full">
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2 px-1">
                            <h4 class="font-bold text-slate-600 text-xs uppercase">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h4>
                            <button onclick="addCarPrompt()" class="text-[10px] bg-slate-200 px-2 py-1 rounded">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        <div id="fleet-cars-list" class="space-y-2"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2 px-1">
                            <h4 class="font-bold text-slate-600 text-xs uppercase">Ø§Ù„ÙƒØ¨Ø§ØªÙ†</h4>
                            <button onclick="addDriverPrompt()" class="text-[10px] bg-slate-200 px-2 py-1 rounded">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        <div id="fleet-drivers-list" class="space-y-2"></div>
                    </div>
                </div>
                <div class="glass-panel p-6 col-span-1 lg:col-span-3 overflow-y-auto bg-slate-50 relative min-h-[300px]" id="ledger-view">
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 opacity-50">
                        <i class="fas fa-folder-open text-6xl mb-4"></i>
                        <p>Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø§Ù„ÙŠ</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-crm" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)</h2>
            <div class="glass-panel overflow-hidden">
                <div class="table-responsive">
                    <table class="w-full text-right text-sm whitespace-nowrap">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th class="p-4">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th class="p-4">Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
                                <th class="p-4">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                            </tr>
                        </thead>
                        <tbody id="crm-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-pricing" class="page-section hidden">
            <div class="glass-panel p-6 max-w-2xl mx-auto">
                <h3 class="font-bold mb-4">Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„ØªØ³Ø¹ÙŠØ±</h3>
                <div id="pricing-list" class="space-y-2 mb-6"></div>
                <h4 class="font-bold text-sm mb-2 mt-6 pt-4 border-t">Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ­Ø©</h4>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-2 items-end">
                    <select id="rule-type" class="input-std col-span-2 md:col-span-1">
                        <option value="sedan">Sedan</option>
                        <option value="suv">SUV</option>
                        <option value="van">Van</option>
                    </select>
                    <input type="number" id="rule-min" placeholder="Ù…Ù† ÙƒÙ…" class="input-std">
                    <input type="number" id="rule-max" placeholder="Ø¥Ù„Ù‰ ÙƒÙ…" class="input-std">
                    <input type="number" id="rule-base" placeholder="ÙØªØ­" class="input-std">
                    <input type="number" id="rule-km" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ" class="input-std">
                </div>
                <button onclick="addPricingTier()" class="w-full mt-4 bg-slate-900 text-white py-2 rounded-lg font-bold">Ø­ÙØ¸</button>
            </div>
        </div>

    </main>

    <div id="assign-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[9000] backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-[500px] shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 border-b pb-3">ØªØ¹ÙŠÙŠÙ† ÙƒØ§Ø¨ØªÙ†</h3>
            <input type="hidden" id="modal-trip-id">
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500">Ø§Ù„ÙƒØ§Ø¨ØªÙ†</label><select id="modal-driver" class="input-std"></select></div>
                <div><label class="text-xs font-bold text-slate-500">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label><select id="modal-car" class="input-std"></select></div>
                <div><label class="text-xs font-bold text-slate-500">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="modal-note" class="input-std h-20"></textarea></div>
                <div class="flex gap-2 pt-2">
                    <button onclick="confirmAssign()" class="flex-1 bg-slate-900 text-white py-2.5 rounded-lg font-bold">ØªØ£ÙƒÙŠØ¯</button>
                    <button onclick="document.getElementById('assign-modal').style.display='none'" class="flex-1 bg-slate-200 text-slate-700 py-2.5 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <div id="complete-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[9000] backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-[400px] shadow-2xl border-t-4 border-green-600 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-green-700 border-b pb-3">ØªØµÙÙŠØ© ÙˆØ¥Ù†Ù‡Ø§Ø¡</h3>
            <input type="hidden" id="comp-trip-id">
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</label><input type="number" id="comp-price" class="input-std font-bold text-green-600" placeholder="0"></div>
                <div class="flex gap-2">
                    <div class="flex-1"><label class="text-xs font-bold text-slate-500">ÙŠÙˆÙ…ÙŠØ©</label><input type="number" id="comp-wage" class="input-std font-bold text-red-600" value="0"></div>
                    <div class="flex-1"><label class="text-xs font-bold text-slate-500">Ø¨Ù†Ø²ÙŠÙ†</label><input type="number" id="comp-fuel" class="input-std font-bold text-amber-600" value="0"></div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="confirmComplete()" class="flex-1 bg-green-600 text-white py-2.5 rounded-lg font-bold hover:bg-green-700">ØªØ£ÙƒÙŠØ¯</button>
                    <button onclick="document.getElementById('complete-modal').style.display='none'" class="flex-1 bg-slate-200 text-slate-700 py-2.5 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <div id="expense-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[9000] backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-[500px] shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 border-b pb-3 text-red-600">ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ©</h3>
            <input type="hidden" id="exp-target-id"> <input type="hidden" id="exp-target-type">
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500">Ø§Ù„Ø¨ÙŠØ§Ù†</label><input type="text" id="exp-modal-title" class="input-std"></div>
                <div><label class="text-xs font-bold text-slate-500">Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="exp-modal-amount" class="input-std"></div>
                <div><label class="text-xs font-bold text-slate-500">Ø§Ù„Ø®Ø²Ù†Ø©</label><select id="exp-modal-vault" class="input-std bg-slate-50"><option value="main">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option></select></div>
                <div class="flex gap-2 pt-2">
                    <button onclick="confirmExpense()" class="flex-1 bg-red-600 text-white py-2.5 rounded-lg font-bold hover:bg-red-700">ØªØ£ÙƒÙŠØ¯</button>
                    <button onclick="document.getElementById('expense-modal').style.display='none'" class="flex-1 bg-slate-200 text-slate-700 py-2.5 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <div id="manual-trip-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[9000] backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-[500px] shadow-2xl max-h-[90vh] overflow-y-auto border-t-4 border-blue-600">
            <h3 class="text-xl font-bold mb-4 border-b pb-3 text-blue-800">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¬Ø² Ù‡Ø§ØªÙÙŠ</h3>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs font-bold text-slate-500">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <input type="text" id="manual-name" class="input-std" placeholder="Ø§Ù„Ø§Ø³Ù…">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="manual-phone" class="input-std" placeholder="01xxxxxxxxx">
                    </div>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <select id="manual-client-type" class="input-std">
                        <option value="new">Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</option>
                        <option value="returning">Ø¹Ù…ÙŠÙ„ Ø­Ø§Ù„ÙŠ (Ù‚Ø¯ÙŠÙ…)</option>
                        <option value="vip">Ø¹Ù…ÙŠÙ„ VIP</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500">Ù…Ù† (Pickup)</label>
                    <input type="text" id="manual-pickup" class="input-std" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500">Ø¥Ù„Ù‰ (Dropoff)</label>
                    <input type="text" id="manual-dropoff" class="input-std" placeholder="Ø§Ù„ÙˆØ¬Ù‡Ø©">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs font-bold text-slate-500">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                        <select id="manual-car-type" class="input-std">
                            <option value="sedan">Ø³ÙŠØ¯Ø§Ù† (4 Ø±ÙƒØ§Ø¨)</option>
                            <option value="suv">SUV (Ø¹Ø§Ø¦Ù„ÙŠØ©)</option>
                            <option value="van">H1 (ÙØ§Ù† Ø³ÙŠØ§Ø­ÙŠ)</option>
                            <option value="limo">Ù„ÙŠÙ…ÙˆØ²ÙŠÙ† ÙØ§Ø®Ø±</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø­Ù„Ø©</label>
                        <select id="manual-trip-type" class="input-std">
                            <option value="one_way">Ø°Ù‡Ø§Ø¨ ÙÙ‚Ø·</option>
                            <option value="round_trip">Ø°Ù‡Ø§Ø¨ ÙˆØ¹ÙˆØ¯Ø©</option>
                            <option value="airport">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…Ø·Ø§Ø±</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs font-bold text-slate-500">Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨</label>
                        <input type="number" id="manual-passengers" class="input-std" value="1" min="1">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500">Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù†Ø·</label>
                        <input type="number" id="manual-luggage" class="input-std" value="0" min="0">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs font-bold text-slate-500">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="manual-date" class="input-std">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500">Ø§Ù„ÙˆÙ‚Øª</label>
                        <input type="time" id="manual-time" class="input-std">
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡</label>
                    <input type="number" id="manual-price" class="input-std text-green-700 font-bold" placeholder="0.00">
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="manual-notes" class="input-std h-16"></textarea>
                </div>

                <div class="flex gap-2 pt-4">
                    <button onclick="submitManualTrip()" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700">Ø­ÙØ¸</button>
                    <button onclick="document.getElementById('manual-trip-modal').style.display='none'" class="flex-1 bg-slate-200 text-slate-700 py-2.5 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://qxtlsfmfetwcflbpvwuf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4dGxzZm1mZXR3Y2ZsYnB2d3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzMzODEsImV4cCI6MjA3ODAwOTM4MX0.FFGXNfx0FDA4FmJB1gVorNigs9nRoO4q1pCj2BOMDbU';
        const sbClient = supabase.createClient(supabaseUrl, supabaseKey);

        showPage('dashboard');

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active'); overlay.classList.remove('active');
            } else {
                sidebar.classList.add('active'); overlay.classList.add('active');
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
            if (window.innerWidth <= 768) { document.getElementById('sidebar').classList.remove('active'); document.getElementById('sidebar-overlay').classList.remove('active'); }
            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'operations') loadOperations();
            if (pageId === 'crm') loadCRM();
            if (pageId === 'finance') loadFinance();
            if (pageId === 'fleet') loadFleetList();
            if (pageId === 'pricing') loadPricing();
        }

        async function loadDashboard() {
            const { count } = await sbClient.from('trips').select('*', { count: 'exact', head: true });
            document.getElementById('kpi-total').innerText = count || 0;
            const { data: vaults } = await sbClient.from('vaults').select('*');
            if (vaults) {
                const main = vaults.find(v => v.name === 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©') || { balance: 0 };
                const maint = vaults.find(v => v.name === 'Ø®Ø²Ù†Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©') || { balance: 0 };
                const cars = vaults.find(v => v.name === 'Ø®Ø²Ù†Ø© Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª') || { balance: 0 };
                document.getElementById('kpi-main-vault').innerText = `${main.balance} EGP`;
                document.getElementById('kpi-maint-vault').innerText = `${maint.balance} EGP`;
                document.getElementById('kpi-cars-salary').innerText = `${cars.balance} EGP`;
            }
        }

        async function loadOperations() {
            const list = document.getElementById('ops-table');
            list.innerHTML = '<tr><td colspan="8" class="text-center p-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            const { data: trips, error } = await sbClient.from('trips').select(`*, cars:cars!fk_trips_car(brand, model, plate_number), drivers:drivers!fk_trips_driver(name, phone)`).order('created_at', { ascending: false });
            if (error) { list.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£</td></tr>'; return; }
            
            const userIds = trips?.map(t => t.user_id).filter(Boolean) || [];
            let profilesMap = {};
            if (userIds.length) {
                const { data: profiles } = await sbClient.from('profiles').select('id, full_name, phone').in('id', userIds);
                if (profiles) profiles.forEach(p => profilesMap[p.id] = p);
            }

            list.innerHTML = '';
            if (!trips?.length) { list.innerHTML = '<tr><td colspan="8" class="text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª</td></tr>'; return; }

            trips.forEach(t => {
                const profile = profilesMap[t.user_id] || { full_name: 'Ø¹Ù…ÙŠÙ„', phone: '-' };
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… ÙÙŠ admin_notes Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ù‚ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
                let displayName = profile.full_name || 'Ø¹Ù…ÙŠÙ„';
                let displayPhone = profile.phone || '-';
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† admin_notes Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠØ§Ù‹
                if (t.admin_notes && t.admin_notes.includes('Ø­Ø¬Ø² Ù‡Ø§ØªÙÙŠ')) {
                    const nameMatch = t.admin_notes.match(/Ø§Ù„Ø¹Ù…ÙŠÙ„: (.*?)\n/);
                    const phoneMatch = t.admin_notes.match(/Ø±Ù‚Ù…: (.*?)\n/);
                    if(nameMatch) displayName = nameMatch[1];
                    if(phoneMatch) displayPhone = phoneMatch[1];
                }

                // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§
                if (t.manual_client_name) displayName = t.manual_client_name;
                if (t.client_phone) displayPhone = t.client_phone;

                let statusColor = 'bg-amber-100 text-amber-800'; 
                if (t.status === 'driver_assigned') statusColor = 'bg-blue-100 text-blue-800';
                else if (t.status === 'approved') statusColor = 'bg-green-100 text-green-800';
                else if (t.status === 'completed') statusColor = 'bg-slate-200 text-slate-600';

                const driverName = t.drivers ? t.drivers.name : '-';
                const carInfo = t.cars ? `${t.cars.brand}` : '-';
                let btns = '';
                if (t.status === 'pending' || t.status === 'approved') btns = `<button onclick="openAssignModal('${t.id}')" class="bg-slate-900 text-white px-2 py-1 rounded text-xs">ØªØ¹ÙŠÙŠÙ†</button>`;
                else if (t.status === 'driver_assigned') btns = `<button onclick="openCompleteModal('${t.id}', ${t.estimated_price})" class="bg-green-600 text-white px-2 py-1 rounded text-xs">Ø¥Ù†Ù‡Ø§Ø¡</button>`;

                list.innerHTML += `
                    <tr class="border-b hover:bg-white text-xs">
                        <td class="p-4">#${t.id.slice(0, 4)}</td>
                        <td class="p-4 font-bold text-slate-800">${displayName}<br><span class="text-[10px] text-slate-500">${displayPhone}</span></td>
                        <td class="p-4 min-w-[180px] whitespace-normal leading-relaxed text-slate-600">${t.admin_notes || '-'}</td>
                        <td class="p-4 font-bold text-slate-500">${t.pickup_location.split(',')[0]} â ${t.dropoff_location.split(',')[0]}</td>
                        <td class="p-4 font-bold">${driverName} / ${carInfo}</td>
                        <td class="p-4 font-bold text-green-700">${t.estimated_price}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-[10px] ${statusColor}">${t.status}</span></td>
                        <td class="p-4">${btns}</td>
                    </tr>
                `;
            });
        }

        function openCompleteModal(tripId, price) {
            document.getElementById('comp-trip-id').value = tripId;
            document.getElementById('comp-price').value = price;
            document.getElementById('comp-wage').value = 0;
            document.getElementById('comp-fuel').value = 0;
            document.getElementById('complete-modal').style.display = 'flex';
        }

        async function confirmComplete() {
            const tripId = document.getElementById('comp-trip-id').value;
            const price = Number(document.getElementById('comp-price').value);
            const wage = Number(document.getElementById('comp-wage').value);
            const fuel = Number(document.getElementById('comp-fuel').value);
            const netToVault = price - wage - fuel;
            if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ØŸ')) return;
            await sbClient.from('trips').update({ status: 'completed', final_price: price, driver_wage: wage }).eq('id', tripId);
            const vid = await getMainVaultId();
            const { data: v } = await sbClient.from('vaults').select('balance').eq('id', vid).single();
            await sbClient.from('vaults').update({ balance: (v.balance || 0) + netToVault }).eq('id', vid);
            const { data: trip } = await sbClient.from('trips').select('driver_id, car_id').eq('id', tripId).single();
            if (wage > 0 && trip.driver_id) await sbClient.from('expenses').insert([{ title: `ÙŠÙˆÙ…ÙŠØ© #${tripId.slice(0,4)}`, amount: wage, category: 'Ø±ÙˆØ§ØªØ¨', related_trip_id: tripId, related_driver_id: trip.driver_id, related_vault_id: vid }]);
            if (fuel > 0 && trip.car_id) await sbClient.from('expenses').insert([{ title: `Ø¨Ù†Ø²ÙŠÙ† #${tripId.slice(0,4)}`, amount: fuel, category: 'ØªØ´ØºÙŠÙ„', related_trip_id: tripId, related_car_id: trip.car_id, related_vault_id: vid }]);
            document.getElementById('complete-modal').style.display = 'none';
            loadOperations(); loadDashboard();
        }

        async function loadFinance() {
            const { data: vaults } = await sbClient.from('vaults').select('*');
            const grid = document.getElementById('vaults-grid');
            const select = document.getElementById('gen-exp-vault');
            const modalSelect = document.getElementById('exp-modal-vault');
            grid.innerHTML = ''; select.innerHTML = '<option value="main">Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>'; modalSelect.innerHTML = '<option value="main">Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>';
            if (vaults) {
                vaults.forEach(v => {
                    grid.innerHTML += `<div class="glass-panel p-5 border-l-4 border-amber-500"><p class="text-xs font-bold text-slate-400 uppercase">${v.name}</p><h3 class="text-2xl font-black mt-1">${v.balance} <span class="text-sm font-normal">EGP</span></h3></div>`;
                    if (v.name !== 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©') { select.innerHTML += `<option value="${v.id}">${v.name}</option>`; modalSelect.innerHTML += `<option value="${v.id}">${v.name}</option>`; }
                });
            }
            const { data: reqs } = await sbClient.from('transactions').select('*').eq('status', 'pending');
            const reqList = document.getElementById('deposit-requests-list');
            reqList.innerHTML = '';
            if (!reqs || reqs.length === 0) { reqList.innerHTML = '<p class="text-center text-slate-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>'; } else {
                const userIds = reqs.map(r => r.user_id);
                let profilesMap = {};
                if (userIds.length > 0) { const { data: profiles } = await sbClient.from('profiles').select('id, full_name').in('id', userIds); if (profiles) profiles.forEach(p => profilesMap[p.id] = p.full_name); }
                reqs.forEach(r => {
                    const clientName = profilesMap[r.user_id] || 'Ø¹Ù…ÙŠÙ„';
                    reqList.innerHTML += `<div class="bg-white border rounded-lg p-3 flex justify-between items-center mb-2"><div><p class="font-bold text-sm text-slate-800">${clientName}</p><p class="text-green-600 font-bold font-num mt-1">${r.amount} EGP</p></div><div class="flex gap-2"><button onclick="processDeposit('${r.id}', '${r.user_id}', ${r.amount}, true)" class="bg-green-600 text-white px-2 py-1 rounded text-xs">Ù‚Ø¨ÙˆÙ„</button><button onclick="processDeposit('${r.id}', null, null, false)" class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs">Ø±ÙØ¶</button></div></div>`;
                });
            }
        }

        async function processDeposit(txId, userId, amount, isApproved) {
            if (isApproved) {
                if (!confirm(`Ù‚Ø¨ÙˆÙ„ ${amount}ØŸ`)) return;
                await sbClient.from('transactions').update({ status: 'approved' }).eq('id', txId);
                const { data: profile } = await sbClient.from('profiles').select('wallet_balance').eq('id', userId).single();
                await sbClient.from('profiles').update({ wallet_balance: (profile?.wallet_balance || 0) + Number(amount) }).eq('id', userId);
                const vid = await getMainVaultId();
                const { data: v } = await sbClient.from('vaults').select('balance').eq('id', vid).single();
                await sbClient.from('vaults').update({ balance: (v.balance || 0) + Number(amount) }).eq('id', vid);
            } else { if (!confirm("Ø±ÙØ¶ØŸ")) return; await sbClient.from('transactions').update({ status: 'rejected' }).eq('id', txId); }
            loadFinance();
        }

        async function addGeneralExpense() {
            const title = document.getElementById('gen-exp-title').value;
            const amount = document.getElementById('gen-exp-amount').value;
            const vaultId = document.getElementById('gen-exp-vault').value;
            if (!title || !amount) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
            const vid = vaultId === 'main' ? (await getMainVaultId()) : vaultId;
            await sbClient.from('expenses').insert([{ title, amount, category: 'Ø¹Ø§Ù…', related_vault_id: vid }]);
            const { data: v } = await sbClient.from('vaults').select('balance').eq('id', vid).single();
            await sbClient.from('vaults').update({ balance: (v.balance || 0) - Number(amount) }).eq('id', vid);
            alert("ØªÙ…"); loadFinance();
        }

        async function getMainVaultId() { const { data } = await sbClient.from('vaults').select('id').eq('name', 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©').single(); return data?.id; }

        async function loadFleetList() {
            const { data: cars } = await sbClient.from('cars').select('*');
            const { data: drivers } = await sbClient.from('drivers').select('*');
            const carsDiv = document.getElementById('fleet-cars-list');
            if (cars) carsDiv.innerHTML = cars.map(c => `<div onclick="openLedger('car', '${c.id}', '${c.brand} ${c.plate_number}', ${c.monthly_salary || 0})" class="bg-white p-3 border rounded cursor-pointer hover:bg-slate-50 mb-2 font-bold flex justify-between"><span>${c.brand}</span><span>${c.plate_number}</span></div>`).join('');
            const driversDiv = document.getElementById('fleet-drivers-list');
            if (drivers) driversDiv.innerHTML = drivers.map(d => `<div onclick="openLedger('driver', '${d.id}', '${d.name}')" class="bg-white p-3 border rounded cursor-pointer hover:bg-slate-50 mb-2 font-bold">${d.name}</div>`).join('');
        }

        async function openLedger(type, id, name, salary = 0) {
            const view = document.getElementById('ledger-view'); view.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            let income = 0; let outcome = 0; let movements = [];
            const { data: exps } = await sbClient.from('expenses').select('*').eq(type === 'car' ? 'related_car_id' : 'related_driver_id', id);
            if (exps) exps.forEach(e => { if (type === 'driver' && e.category === 'ÙŠÙˆÙ…ÙŠØ©') { income += e.amount; movements.push({ date: e.created_at, title: e.title, amount: e.amount, type: 'in' }); } else { outcome += e.amount; movements.push({ date: e.created_at, title: e.title, amount: -e.amount, type: 'out' }); } });
            if (type === 'car') { const { data: trips } = await sbClient.from('trips').select('*').eq('car_id', id).eq('status', 'completed'); if (trips) trips.forEach(t => { income += t.final_price; movements.push({ date: t.created_at, title: `Ø¥ÙŠØ±Ø§Ø¯`, amount: t.final_price, type: 'in' }); }); }
            movements.sort((a, b) => new Date(b.date) - new Date(a.date));
            let extraBtn = type === 'car' ? `<button onclick="payCarSalary('${id}', ${salary})" class="w-full bg-purple-600 text-white py-2 rounded mt-4">Ø³Ø¯Ø§Ø¯ Ø±Ø§ØªØ¨ (${salary})</button>` : '';
            view.innerHTML = `<h3 class="font-bold text-xl mb-4 border-b pb-2">${name}</h3><div class="grid grid-cols-3 gap-2 mb-4 text-center text-xs"><div class="bg-green-50 p-2 rounded"><p>Ø¥ÙŠØ±Ø§Ø¯</p><p class="font-bold text-green-700">${income}</p></div><div class="bg-red-50 p-2 rounded"><p>Ù…ØµØ±ÙˆÙ</p><p class="font-bold text-red-700">${outcome}</p></div><div class="bg-slate-100 p-2 rounded"><p>ØµØ§ÙÙŠ</p><p class="font-bold">${income - outcome}</p></div></div><button onclick="openExpenseModal('${type}', '${id}')" class="w-full bg-red-600 text-white py-2 rounded mb-2">ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ©</button>${extraBtn}<div class="mt-4 space-y-2 max-h-60 overflow-y-auto">${movements.map(m => `<div class="flex justify-between text-xs border-b pb-1"><span>${m.title}</span><span class="${m.type === 'in' ? 'text-green-600' : 'text-red-600'}">${m.amount}</span></div>`).join('')}</div>`;
        }

        async function payCarSalary(carId, amount) {
            if (!confirm(`Ø³Ø¯Ø§Ø¯ ${amount}ØŸ`)) return;
            const vid = await getMainVaultId();
            await sbClient.from('expenses').insert([{ title: 'Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ', amount: amount, category: 'Ø±ÙˆØ§ØªØ¨ Ø³ÙŠØ§Ø±Ø§Øª', related_car_id: carId }]);
            const { data: v } = await sbClient.from('vaults').select('balance').eq('id', vid).single();
            await sbClient.from('vaults').update({ balance: (v.balance || 0) - amount }).eq('id', vid);
            alert("ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯"); openLedger('car', carId, '...');
        }

        async function openExpenseModal(type, id) { document.getElementById('expense-modal').style.display = 'flex'; document.getElementById('exp-target-type').value = type; document.getElementById('exp-target-id').value = id; }
        async function confirmExpense() {
            const type = document.getElementById('exp-target-type').value; const id = document.getElementById('exp-target-id').value; const title = document.getElementById('exp-modal-title').value; const amount = document.getElementById('exp-modal-amount').value; const vaultId = document.getElementById('exp-modal-vault').value;
            if (!title || !amount) return alert("Ù†Ø§Ù‚ØµØ©");
            const mainVaultId = await getMainVaultId();
            const insertData = { title, amount, category: 'ÙŠØ¯ÙˆÙŠ', related_vault_id: vaultId };
            if (type === 'car') insertData.related_car_id = id; if (type === 'driver') insertData.related_driver_id = id;
            const { error } = await sbClient.from('expenses').insert([insertData]);
            if (!error) { const { data: mainV } = await sbClient.from('vaults').select('balance').eq('id', mainVaultId).single(); await sbClient.from('vaults').update({ balance: (mainV.balance || 0) - Number(amount) }).eq('id', mainVaultId); if (vaultId !== 'main' && vaultId !== mainVaultId) { const { data: subV } = await sbClient.from('vaults').select('balance').eq('id', vaultId).single(); await sbClient.from('vaults').update({ balance: (subV.balance || 0) - Number(amount) }).eq('id', vaultId); } document.getElementById('expense-modal').style.display = 'none'; alert("ØªÙ…"); openLedger(type, id, '...'); loadFinance(); } else { alert(error.message); }
        }

        async function loadCRM() {
            const list = document.getElementById('crm-table'); const { data: profiles } = await sbClient.from('profiles').select('*'); list.innerHTML = ''; if (!profiles || profiles.length === 0) list.innerHTML = '<tr><td colspan="4" class="text-center p-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'; else profiles.forEach(p => { list.innerHTML += `<tr class="border-b bg-white"><td class="p-4 font-bold text-slate-700">${p.full_name || '-'}</td><td class="p-4 text-slate-500">${p.phone || '-'}</td><td class="p-4 font-bold ${p.wallet_balance < 0 ? 'text-red-500' : 'text-green-600'}">${p.wallet_balance || 0}</td><td class="p-4 text-xs text-slate-400">${new Date(p.created_at).toLocaleDateString()}</td></tr>`; });
        }
        async function loadPricing() { const { data } = await sbClient.from('pricing_tiers').select('*'); document.getElementById('pricing-list').innerHTML = data.map(r => `<div class="bg-white p-2 border rounded mb-2 flex justify-between"><span>${r.car_type}</span><span>${r.price_per_km}/km</span></div>`).join(''); }
        async function addPricingTier() { const type = document.getElementById('rule-type').value, min = document.getElementById('rule-min').value, max = document.getElementById('rule-max').value, base = document.getElementById('rule-base').value, km = document.getElementById('rule-km').value; await sbClient.from('pricing_tiers').insert([{ car_type: type, min_km: min, max_km: max, base_price: base, price_per_km: km }]); loadPricing(); }
        async function openAssignModal(id) { document.getElementById('modal-trip-id').value = id; document.getElementById('assign-modal').style.display = 'flex'; const { data: d } = await sbClient.from('drivers').select('*'); const { data: c } = await sbClient.from('cars').select('*'); const dSel = document.getElementById('modal-driver'); dSel.innerHTML = ''; d.forEach(x => dSel.innerHTML += `<option value="${x.id}">${x.name}</option>`); const cSel = document.getElementById('modal-car'); cSel.innerHTML = ''; c.forEach(x => cSel.innerHTML += `<option value="${x.id}">${x.brand}</option>`); }
        async function confirmAssign() { const tid = document.getElementById('modal-trip-id').value, did = document.getElementById('modal-driver').value, cid = document.getElementById('modal-car').value, note = document.getElementById('modal-note').value; await sbClient.from('trips').update({ driver_id: did, car_id: cid, admin_notes: note, status: 'driver_assigned' }).eq('id', tid); document.getElementById('assign-modal').style.display = 'none'; loadOperations(); }
        async function addCarPrompt() { const b = prompt("Ø§Ù„Ù…Ø§Ø±ÙƒØ©:"); const p = prompt("Ø§Ù„Ù„ÙˆØ­Ø©:"); const s = prompt("Ø§Ù„Ø±Ø§ØªØ¨:"); if (b) { await sbClient.from('cars').insert([{ brand: b, plate_number: p, monthly_salary: s || 0 }]); loadFleetList(); } }
        async function addDriverPrompt() { const n = prompt("Ø§Ù„Ø§Ø³Ù…:"); const p = prompt("Ù‡Ø§ØªÙ:"); if (n) { await sbClient.from('drivers').insert([{ name: n, phone: p }]); loadFleetList(); } }

        new Chart(document.getElementById('tripsChart'), { type: 'bar', data: { labels: ['S', 'M', 'T', 'W', 'T', 'F', 'S'], datasets: [{ label: 'Ø§Ù„Ø±Ø­Ù„Ø§Øª', data: [5, 8, 12, 7, 15, 10, 9], backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } } } });

        // --- ÙˆØ¸ÙŠÙØ© Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡) ---
        async function submitManualTrip() {
            // 1. Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const name = document.getElementById('manual-name').value;
            const phone = document.getElementById('manual-phone').value;
            const pickup = document.getElementById('manual-pickup').value;
            const dropoff = document.getElementById('manual-dropoff').value;
            const date = document.getElementById('manual-date').value;
            const time = document.getElementById('manual-time').value;
            const price = document.getElementById('manual-price').value;
            const notes = document.getElementById('manual-notes').value;
            
            // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const clientType = document.getElementById('manual-client-type').value;
            const carType = document.getElementById('manual-car-type').value;
            const tripType = document.getElementById('manual-trip-type').value;
            const passengers = document.getElementById('manual-passengers').value;
            const luggage = document.getElementById('manual-luggage').value;

            // 2. Ø§Ù„ØªØ­Ù‚Ù‚
            if (!name || !phone || !pickup || !dropoff || !price) {
                alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„Ø³Ø¹Ø±)");
                return;
            }

            // 3. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†Øµ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ Ù„ØªØ®Ø²ÙŠÙ† ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            const fullNotes = `Ø­Ø¬Ø² Ù‡Ø§ØªÙÙŠ ğŸ“
Ø§Ù„Ø¹Ù…ÙŠÙ„: ${name} (${clientType})
Ø±Ù‚Ù…: ${phone}
Ø³ÙŠØ§Ø±Ø©: ${carType} | Ø±Ø­Ù„Ø©: ${tripType}
Ø±ÙƒØ§Ø¨: ${passengers} | Ø´Ù†Ø·: ${luggage}
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date} | Ø§Ù„ÙˆÙ‚Øª: ${time}
Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: ${notes}`;

            try {
                // 4. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Supabase
                const { error } = await sbClient.from('trips').insert([{
                    // Ù„Ø§ Ù†Ø±Ø³Ù„ client_phone Ø£Ùˆ manual_client_name Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø·Ø£
                    // Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ admin_notes ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ (ÙƒÙ…Ø§ Ø¹Ø¯Ù„Øª Ø¯Ø§Ù„Ø© loadOperations)
                    pickup_location: pickup,
                    dropoff_location: dropoff,
                    estimated_price: Number(price),
                    status: 'pending',
                    admin_notes: fullNotes
                }]);

                if (error) throw error;

                // 5. Ù†Ø¬Ø§Ø­
                alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­");
                document.getElementById('manual-trip-modal').style.display = 'none';
                
                // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                document.getElementById('manual-name').value = '';
                document.getElementById('manual-phone').value = '';
                document.getElementById('manual-pickup').value = '';
                document.getElementById('manual-dropoff').value = '';
                document.getElementById('manual-price').value = '';
                
                loadOperations();
                loadDashboard();

            } catch (err) {
                console.error(err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + err.message);
            }
        }
    </script>
</body>
</html>