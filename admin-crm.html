<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24Seven | ERP System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        .sidebar-item { transition: all 0.2s; cursor: pointer; border-right: 3px solid transparent; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #e2e8f0; color: #0f172a; font-weight: bold; border-right-color: #f59e0b; }
        .glass-panel { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800">

    <aside class="w-64 bg-white border-l border-slate-200 flex flex-col z-20 shadow-lg shrink-0">
        <div class="h-16 flex items-center justify-center border-b border-slate-100 bg-slate-900 text-white">
            <h1 class="text-xl font-black">24<span class="text-amber-500">Seven</span> <span class="text-[10px] font-normal text-slate-400">ERP v3.0</span></h1>
        </div>
        
        <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
            <div onclick="showPage('dashboard')" id="nav-dashboard" class="sidebar-item active p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-home w-5 text-center text-blue-600"></i> الرئيسية
            </div>
            
            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">العمليات</p>
            <div onclick="showPage('operations')" id="nav-operations" class="sidebar-item p-3 rounded-lg flex items-center gap-3 justify-between">
                <div class="flex items-center gap-3"><i class="fas fa-satellite-dish w-5 text-center text-amber-600"></i> غرفة العمليات</div>
                <span id="pending-badge" class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full hidden">0</span>
            </div>
            <div onclick="showPage('crm')" id="nav-crm" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-users w-5 text-center text-purple-600"></i> ملفات العملاء
            </div>

            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">المالية والأسطول</p>
            <div onclick="showPage('accounting')" id="nav-accounting" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-calculator w-5 text-center text-green-600"></i> الحسابات
            </div>
            <div onclick="showPage('fleet')" id="nav-fleet" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-car w-5 text-center text-slate-600"></i> الأسطول والكباتن
            </div>
            <div onclick="showPage('pricing')" id="nav-pricing" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-tags w-5 text-center text-gray-600"></i> التسعير
            </div>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-6 relative">
        
        <div id="page-dashboard" class="page-section">
            <h2 class="text-2xl font-bold mb-6">نظرة عامة</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-panel p-6 border-b-4 border-blue-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">الرحلات</p>
                    <h3 class="text-3xl font-black mt-2" id="kpi-total-trips">--</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-amber-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">الانتظار</p>
                    <h3 class="text-3xl font-black mt-2 text-amber-600" id="kpi-pending">--</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-green-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">الخزينة</p>
                    <h3 class="text-3xl font-black mt-2 text-green-600" id="kpi-treasury">0 EGP</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-purple-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">العملاء</p>
                    <h3 class="text-3xl font-black mt-2" id="kpi-users">--</h3>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-panel p-6">
                    <h3 class="font-bold mb-4">أداء الرحلات</h3>
                    <canvas id="tripsChart"></canvas>
                </div>
                <div class="glass-panel p-6">
                    <h3 class="font-bold mb-4">أسطول السيارات</h3>
                    <canvas id="carsChart"></canvas>
                </div>
            </div>
        </div>

        <div id="page-operations" class="page-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">غرفة العمليات</h2>
                <button onclick="loadOperations()" class="bg-white border hover:bg-slate-50 px-4 py-2 rounded shadow-sm text-sm"><i class="fas fa-sync-alt"></i> تحديث</button>
            </div>
            <div class="glass-panel overflow-hidden">
                <table class="w-full text-right">
                    <thead class="bg-slate-100 text-slate-600 font-bold">
                        <tr>
                            <th class="p-4">#</th>
                            <th class="p-4">العميل</th>
                            <th class="p-4">المسار</th>
                            <th class="p-4">المركبة</th>
                            <th class="p-4">السعر</th>
                            <th class="p-4">الحالة</th>
                            <th class="p-4">تحكم</th>
                        </tr>
                    </thead>
                    <tbody id="ops-table" class="divide-y divide-slate-100 text-sm font-medium"></tbody>
                </table>
            </div>
        </div>

        <div id="page-crm" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">ملفات العملاء</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 glass-panel p-4 h-[600px] overflow-y-auto">
                    <input type="text" id="crm-search" onkeyup="filterCRM()" placeholder="بحث..." class="w-full p-2 border rounded-lg mb-4 bg-slate-50">
                    <div id="crm-users-list" class="space-y-2"></div>
                </div>
                <div class="lg:col-span-2 glass-panel p-6" id="crm-detail-view">
                    <div class="text-center text-slate-400 py-20">
                        <i class="fas fa-user-circle text-6xl mb-4"></i>
                        <p>اختر عميلاً للعرض</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-accounting" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">الإدارة المالية</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="glass-panel p-6 border-t-4 border-red-500">
                    <h3 class="font-bold mb-4 text-red-600">تسجيل مصروف</h3>
                    <div class="space-y-3">
                        <input type="text" id="exp-title" placeholder="بند الصرف" class="w-full p-2 border rounded">
                        <input type="number" id="exp-amount" placeholder="المبلغ" class="w-full p-2 border rounded">
                        <select id="exp-category" class="w-full p-2 border rounded bg-white">
                            <option>وقود</option><option>صيانة</option><option>رواتب</option><option>نثريات</option>
                        </select>
                        <select id="exp-related-to" class="w-full p-2 border rounded bg-white text-sm">
                             <option value="">تحميل على (اختياري)</option>
                             <optgroup id="exp-drivers-opt" label="الكباتن"></optgroup>
                        </select>
                        <button onclick="addExpense()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700">خصم</button>
                    </div>
                </div>
                <div class="col-span-2 glass-panel p-6 border-t-4 border-green-500">
                    <h3 class="font-bold mb-4 text-green-600">تحصيلات (InstaPay)</h3>
                    <div id="finance-pending-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            <div class="glass-panel p-6">
                <h3 class="font-bold mb-4">سجل الخزينة</h3>
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-50"><tr><th class="p-3">التاريخ</th><th class="p-3">النوع</th><th class="p-3">البيان</th><th class="p-3">المبلغ</th></tr></thead>
                    <tbody id="treasury-log"></tbody>
                </table>
            </div>
        </div>

        <div id="page-fleet" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">الأسطول</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-panel p-6">
                    <div class="flex justify-between mb-4 border-b pb-2">
                        <h3 class="font-bold">الكباتن</h3>
                        <button onclick="addDriverPrompt()" class="text-blue-600 text-xs font-bold">+ إضافة</button>
                    </div>
                    <div id="fleet-drivers-view" class="space-y-3"></div>
                </div>
                <div class="glass-panel p-6">
                    <div class="flex justify-between mb-4 border-b pb-2">
                        <h3 class="font-bold">المركبات</h3>
                        <button onclick="addCarPrompt()" class="text-amber-600 text-xs font-bold">+ إضافة</button>
                    </div>
                    <div id="fleet-cars-view" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <div id="page-pricing" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">إعدادات التسعير</h2>
            <div class="glass-panel p-6" id="pricing-container">
                <div id="pricing-list" class="space-y-2 mb-4"></div>
                <button onclick="addPricingRule()" class="bg-slate-800 text-white w-full py-2 rounded">إضافة شريحة</button>
            </div>
        </div>

    </main>

    <div id="assign-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl w-[450px] shadow-2xl animate-fade-in-up">
            <h3 class="text-lg font-bold mb-4 border-b pb-2">إسناد المهمة</h3>
            <input type="hidden" id="modal-trip-id">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">الكابتن</label>
                    <select id="modal-driver" class="w-full p-2 border rounded bg-slate-50"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">السيارة</label>
                    <select id="modal-car" class="w-full p-2 border rounded bg-slate-50"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ملاحظات</label>
                    <textarea id="modal-notes" class="w-full p-2 border rounded mt-1 h-20"></textarea>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="confirmAssignment()" class="flex-1 bg-slate-900 text-white py-2 rounded">تأكيد</button>
                    <button onclick="document.getElementById('assign-modal').style.display='none'" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://qxtlsfmfetwcflbpvwuf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4dGxzZm1mZXR3Y2ZsYnB2d3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzMzODEsImV4cCI6MjA3ODAwOTM4MX0.FFGXNfx0FDA4FmJB1gVorNigs9nRoO4q1pCj2BOMDbU';
        const sbClient = supabase.createClient(supabaseUrl, supabaseKey);

        initSystem();

        function initSystem() {
            renderCharts();
            loadKPIs();
            loadOperations();
            loadFinance();
            loadCRM();
            loadFleet();
            loadPricing();
        }

        function showPage(id) {
            document.querySelectorAll('.page-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`page-${id}`).classList.remove('hidden');
            document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`nav-${id}`).classList.add('active');
            
            if(id === 'operations') loadOperations();
            if(id === 'crm') loadCRM();
            if(id === 'finance' || id === 'accounting') loadFinance();
            if(id === 'fleet') loadFleet();
        }

        // 1. OPERATIONS
        async function loadOperations() {
            const tbody = document.getElementById('ops-table');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">جاري التحميل...</td></tr>';

            const { data: trips, error } = await sbClient
                .from('trips')
                .select('*, profiles:user_id(*), drivers:driver_id(*), cars:car_id(*)')
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-red-500">خطأ في الاتصال</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            if(!trips.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-slate-400">لا توجد رحلات</td></tr>';
                return;
            }

            trips.forEach(t => {
                const clientName = t.profiles?.full_name || t.profiles?.name || 'ضيف';
                const clientPhone = t.profiles?.phone || t.profiles?.phone_number || 'غير مسجل';
                const driverName = t.drivers?.name || '-';
                const carInfo = t.cars ? `${t.cars.brand} ${t.cars.model}` : '-';
                
                let statusBadge = '';
                let actions = '';

                if(t.status === 'pending') {
                    statusBadge = '<span class="bg-amber-100 text-amber-700 status-badge">انتظار</span>';
                    actions = `<button onclick="openAssign('${t.id}')" class="bg-slate-800 text-white px-3 py-1 rounded text-xs">تعيين</button>`;
                } else if(t.status === 'approved') {
                    statusBadge = '<span class="bg-blue-100 text-blue-700 status-badge">جاري</span>';
                    actions = `<span class="text-xs text-slate-500"><i class="fas fa-user-check"></i> ${driverName}</span>`;
                } else {
                    statusBadge = '<span class="bg-green-100 text-green-700 status-badge">مكتمل</span>';
                    actions = '<i class="fas fa-check text-green-500"></i>';
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                        <td class="p-4 font-mono text-slate-400 text-xs">#${t.id.slice(0,6)}</td>
                        <td class="p-4">
                            <div class="font-bold text-sm text-slate-800">${clientName}</div>
                            <div class="text-xs text-blue-500 dir-ltr text-right cursor-pointer" onclick="window.open('https://wa.me/${clientPhone}')">${clientPhone} <i class="fab fa-whatsapp"></i></div>
                        </td>
                        <td class="p-4">
                            <div class="text-xs"><span class="font-bold text-green-600">من:</span> ${t.pickup_location.split(',')[0]}</div>
                            <div class="text-xs mt-1"><span class="font-bold text-red-600">إلى:</span> ${t.dropoff_location.split(',')[0]}</div>
                        </td>
                        <td class="p-4 text-xs font-bold text-slate-600">${t.status === 'approved' ? carInfo : t.car_type.toUpperCase()}</td>
                        <td class="p-4 font-bold text-green-700">${t.estimated_price} ج.م</td>
                        <td class="p-4">${statusBadge}</td>
                        <td class="p-4">${actions}</td>
                    </tr>
                `;
            });
        }

        // 2. ASSIGNMENT LOGIC (إصلاح مشكلة FK)
        async function openAssign(tripId) {
            document.getElementById('modal-trip-id').value = tripId;
            document.getElementById('assign-modal').style.display = 'flex';
            
            // تحميل الكباتن (نشط فقط)
            const { data: drivers } = await sbClient.from('drivers').select('id, name, phone').eq('status', 'active');
            const drSelect = document.getElementById('modal-driver');
            drSelect.innerHTML = '<option value="">-- اختر الكابتن --</option>';
            if(drivers) {
                drivers.forEach(d => drSelect.innerHTML += `<option value="${d.id}">${d.name} (${d.phone})</option>`);
            }

            // تحميل السيارات (نشط فقط)
            const { data: cars } = await sbClient.from('cars').select('id, brand, model, plate_number').eq('status', 'active');
            const carSelect = document.getElementById('modal-car');
            carSelect.innerHTML = '<option value="">-- اختر السيارة --</option>';
            if(cars) {
                cars.forEach(c => carSelect.innerHTML += `<option value="${c.id}">${c.brand} ${c.model} (${c.plate_number})</option>`);
            }
        }

        async function confirmAssignment() {
            const tripId = document.getElementById('modal-trip-id').value;
            const driverId = document.getElementById('modal-driver').value;
            const carId = document.getElementById('modal-car').value;
            const notes = document.getElementById('modal-notes').value;

            // حماية من الإرسال الفارغ
            if(!driverId || driverId === "") return alert("⛔ يجب اختيار كابتن من القائمة");
            if(!carId || carId === "") return alert("⛔ يجب اختيار سيارة من القائمة");

            const btn = event.target;
            btn.innerHTML = 'جاري الحفظ...';
            btn.disabled = true;

            const { error } = await sbClient.from('trips').update({
                driver_id: driverId,
                car_id: carId,
                admin_notes: notes,
                status: 'approved'
            }).eq('id', tripId);

            if(error) {
                alert("خطأ: " + error.message);
                btn.innerHTML = 'تأكيد';
                btn.disabled = false;
            } else {
                alert("تم التعيين بنجاح ✅");
                document.getElementById('assign-modal').style.display = 'none';
                loadOperations();
                loadKPIs();
                btn.innerHTML = 'تأكيد';
                btn.disabled = false;
            }
        }

        // 3. CRM
        async function loadCRM() {
            const list = document.getElementById('crm-users-list');
            const { data: profiles } = await sbClient.from('profiles').select('*').limit(20);
            list.innerHTML = '';
            
            if(profiles) {
                profiles.forEach(p => {
                    const name = p.full_name || p.name || 'عميل';
                    list.innerHTML += `
                        <div onclick="viewClient('${p.id}')" class="bg-white border p-3 rounded cursor-pointer hover:bg-slate-50 flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center font-bold text-purple-600">${name[0]}</div>
                            <div class="overflow-hidden">
                                <p class="font-bold text-sm truncate">${name}</p>
                                <p class="text-xs text-slate-400">${p.phone || ''}</p>
                            </div>
                        </div>
                    `;
                });
            }
        }

        async function viewClient(id) {
            const container = document.getElementById('crm-details');
            container.innerHTML = '<div class="text-center p-10"><i class="fas fa-spinner fa-spin"></i></div>';
            
            const { data: profile } = await sbClient.from('profiles').select('*').eq('id', id).single();
            const { data: trips } = await sbClient.from('trips').select('*').eq('user_id', id).order('created_at', {ascending:false});
            const { data: finances } = await sbClient.from('transactions').select('*').eq('user_id', id).eq('status', 'approved');
            
            const totalSpent = finances ? finances.reduce((a,b)=>a+b.amount,0) : 0;
            const tripList = trips.map(t => `<div class="flex justify-between border-b py-2 text-xs"><span>${new Date(t.created_at).toLocaleDateString()}</span> <span>${t.dropoff_location}</span> <span class="font-bold">${t.estimated_price}ج</span></div>`).join('');

            container.innerHTML = `
                <div class="flex items-start gap-4 mb-6 border-b pb-6">
                    <div class="w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center text-3xl text-slate-500 font-bold">${(profile.full_name||'U')[0]}</div>
                    <div>
                        <h2 class="text-xl font-bold">${profile.full_name || 'عميل'}</h2>
                        <p class="text-slate-500">${profile.phone || 'لا يوجد هاتف'} | ${profile.email}</p>
                        <div class="mt-2 flex gap-2">
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">محفظة: ${profile.wallet_balance || 0} ج.م</span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-slate-50 p-4 rounded text-center">
                        <p class="text-xs text-slate-400 font-bold">إجمالي الرحلات</p>
                        <p class="text-2xl font-bold">${trips.length}</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded text-center">
                        <p class="text-xs text-slate-400 font-bold">إجمالي المدفوعات</p>
                        <p class="text-2xl font-bold text-green-600">${totalSpent} ج.م</p>
                    </div>
                </div>
                <h3 class="font-bold mb-3">سجل الرحلات</h3>
                <div class="max-h-64 overflow-y-auto">${tripList || '<p class="text-slate-400 text-sm">لا توجد رحلات سابقة</p>'}</div>
            `;
        }

        // 4. FINANCE
        async function loadFinance() {
            const { data: pending } = await sbClient.from('transactions').select('*, profiles:user_id(full_name)').eq('status', 'pending');
            const list = document.getElementById('finance-pending-list');
            list.innerHTML = '';
            
            if(pending && pending.length > 0) {
                pending.forEach(tx => {
                    const userName = tx.profiles?.full_name || 'عميل';
                    list.innerHTML += `
                        <div class="bg-white border p-2 rounded flex justify-between items-center text-sm mb-2">
                            <div>
                                <span class="font-bold text-green-600">+${tx.amount}</span>
                                <span class="text-xs text-slate-500 block">${userName} (Ref: ${tx.reference_id})</span>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="processTx('${tx.id}', '${tx.user_id}', ${tx.amount}, 'approve')" class="bg-green-500 text-white px-2 rounded text-xs">✔</button>
                                <button onclick="processTx('${tx.id}', '${tx.user_id}', 0, 'reject')" class="bg-red-500 text-white px-2 rounded text-xs">✖</button>
                            </div>
                        </div>
                    `;
                });
            } else { list.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">لا توجد طلبات معلقة</p>'; }

            // Drivers list for expenses
            const { data: drv } = await sbClient.from('drivers').select('id, name').eq('status', 'active');
            if(drv) document.getElementById('exp-related-to').innerHTML += `<optgroup label="الكباتن">${drv.map(d => `<option value="driver:${d.id}">${d.name}</option>`).join('')}</optgroup>`;
        }

        async function addExpense() {
            const title = document.getElementById('exp-title').value;
            const amount = document.getElementById('exp-amount').value;
            if(!title || !amount) return alert("أدخل البيانات");
            const log = document.getElementById('treasury-log');
            log.innerHTML = `<tr class="bg-red-50 text-red-700 border-b"><td class="p-3">${new Date().toLocaleDateString()}</td><td class="p-3 font-bold">مصروف</td><td class="p-3">${title}</td><td class="p-3 font-bold">-${amount}</td></tr>` + log.innerHTML;
            alert("تم التسجيل");
        }

        async function processTx(id, uid, amount, action) {
            if(!confirm("تأكيد؟")) return;
            const status = action === 'approve' ? 'approved' : 'rejected';
            await sbClient.from('transactions').update({status}).eq('id', id);
            
            if(action === 'approve') {
                const {data} = await sbClient.from('profiles').select('wallet_balance').eq('id', uid).single();
                const newBal = (data.wallet_balance || 0) + Number(amount);
                await sbClient.from('profiles').update({wallet_balance: newBal}).eq('id', uid);
            }
            loadFinance();
        }

        // 5. Fleet (FIXED: Auto Active Status)
        async function loadFleet() {
            const { data: drivers } = await sbClient.from('drivers').select('*');
            const { data: cars } = await sbClient.from('cars').select('*');
            
            document.getElementById('fleet-drivers-view').innerHTML = drivers.map(d => `
                <div class="flex justify-between items-center border p-3 rounded bg-white">
                    <div>
                        <p class="font-bold text-sm">${d.name}</p>
                        <p class="text-xs text-slate-400">${d.phone}</p>
                    </div>
                    <span class="bg-green-100 text-green-700 text-[10px] px-2 rounded">${d.status || 'نشط'}</span>
                </div>
            `).join('');

            document.getElementById('fleet-cars-view').innerHTML = cars.map(c => `
                <div class="flex justify-between items-center border p-3 rounded bg-white">
                    <div>
                        <p class="font-bold text-sm">${c.brand} ${c.model}</p>
                        <p class="text-xs text-slate-400">${c.plate_number}</p>
                    </div>
                    <span class="bg-slate-100 text-slate-700 text-[10px] px-2 rounded">${c.type}</span>
                </div>
            `).join('');
        }

        async function addDriverPrompt() {
            const n = prompt("الاسم:"); const p = prompt("الهاتف:");
            // إضافة الحالة active تلقائياً لتجنب مشاكل التعيين
            if(n && p) { await sbClient.from('drivers').insert([{name:n, phone:p, status:'active'}]); loadFleet(); }
        }
        async function addCarPrompt() {
            const b = prompt("الماركة:"); const m = prompt("الموديل:"); const pl = prompt("اللوحة:");
            // إضافة الحالة active تلقائياً
            if(b && pl) { await sbClient.from('cars').insert([{brand:b, model:m, plate_number:pl, type:'sedan', status:'active'}]); loadFleet(); }
        }

        // 6. Pricing
        async function loadPricing() {
            const { data } = await sbClient.from('pricing_rules').select('*');
            document.getElementById('pricing-list').innerHTML = data.map(r => 
                `<div class="flex justify-between bg-white p-2 border rounded text-xs"><span>${r.car_type}</span> <span class="font-bold text-green-600">${r.price_per_km} ج/كم</span></div>`
            ).join('');
        }
        async function addPricingRule() {
            const type = prompt("نوع السيارة (sedan/suv):");
            const price = prompt("سعر الكيلو:");
            if(type && price) { await sbClient.from('pricing_rules').insert([{car_type:type, price_per_km:price, min_km:0, max_km:1000, base_fare:50}]); loadPricing(); }
        }

        // KPIs
        async function loadKPIs() {
            const { count: pending } = await sbClient.from('trips').select('*', { count: 'exact', head: true }).eq('status', 'pending');
            document.getElementById('kpi-pending').innerText = pending || 0;
            if(pending > 0) document.getElementById('pending-badge').classList.remove('hidden');
        }

        function renderCharts() {
            new Chart(document.getElementById('tripsChart'), {
                type: 'line', data: { labels: ['S', 'M', 'T', 'W', 'T', 'F', 'S'], datasets: [{ label: 'الرحلات', data: [12, 19, 3, 5, 2, 3, 15], borderColor: '#3b82f6' }] }
            });
            new Chart(document.getElementById('carsChart'), {
                type: 'doughnut', data: { labels: ['Sedan', 'SUV', 'Van'], datasets: [{ data: [60, 25, 15], backgroundColor: ['#f59e0b', '#3b82f6', '#10b981'] }] }
            });
        }

        // Refresh
        setInterval(() => {
            if(!document.getElementById('page-operations').classList.contains('hidden')) loadOperations();
            loadKPIs();
        }, 15000);

    </script>
</body>
</html>