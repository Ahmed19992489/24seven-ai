<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24Seven | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        .sidebar-item { transition: all 0.2s; cursor: pointer; border-right: 3px solid transparent; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #e2e8f0; color: #0f172a; font-weight: bold; border-right-color: #f59e0b; }
        .glass-panel { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¨Ø¶ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .badge-pulse { animation: pulse-red 2s infinite; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800">

    <aside class="w-64 bg-white border-l border-slate-200 flex flex-col z-20 shadow-lg shrink-0">
        <div class="h-16 flex items-center justify-center border-b border-slate-100 bg-slate-900 text-white">
            <h1 class="text-xl font-black">24<span class="text-amber-500">Seven</span> <span class="text-[10px] font-normal text-slate-400">ERP Pro</span></h1>
        </div>
        
        <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
            <div onclick="showPage('dashboard')" id="nav-dashboard" class="sidebar-item active p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-home w-5 text-center text-blue-600"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </div>
            
            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
            <div onclick="showPage('operations')" id="nav-operations" class="sidebar-item p-3 rounded-lg flex items-center gap-3 justify-between">
                <div class="flex items-center gap-3"><i class="fas fa-satellite-dish w-5 text-center text-amber-600"></i> ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                <span id="pending-badge" class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full hidden badge-pulse">0</span>
            </div>
            <div onclick="showPage('crm')" id="nav-crm" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-users w-5 text-center text-purple-600"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)
            </div>

            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø£Ø³Ø·ÙˆÙ„</p>
            <div onclick="showPage('accounting')" id="nav-accounting" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-calculator w-5 text-center text-green-600"></i> Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
            </div>
            <div onclick="showPage('fleet')" id="nav-fleet" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-car w-5 text-center text-slate-600"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„
            </div>
            
            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">Ø§Ù„ØªØ³ÙˆÙŠÙ‚ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
            <div onclick="showPage('coupons')" id="nav-coupons" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-ticket-alt w-5 text-center text-pink-500"></i> Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª
            </div>
            <div onclick="showPage('pricing')" id="nav-pricing" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-tags w-5 text-center text-gray-600"></i> Ø§Ù„ØªØ³Ø¹ÙŠØ±
            </div>
        </nav>
        
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold">AH</div>
                <div>
                    <p class="text-sm font-bold">Ahmed Hashem</p>
                    <p class="text-[10px] text-green-600 font-bold">â— Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-6 relative bg-[#f1f5f9]">
        
        <div id="page-dashboard" class="page-section">
            <h2 class="text-2xl font-bold mb-6">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-panel p-6 border-b-4 border-blue-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª</p>
                    <h3 class="text-3xl font-black mt-2" id="kpi-total-trips">--</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-amber-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
                    <h3 class="text-3xl font-black mt-2 text-amber-600" id="kpi-pending">--</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-green-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">Ø±ØµÙŠØ¯ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</p>
                    <h3 class="text-3xl font-black mt-2 text-green-600" id="kpi-treasury">0 EGP</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-pink-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ù…ÙØ¹Ù„Ø©</p>
                    <h3 class="text-3xl font-black mt-2" id="kpi-coupons">--</h3>
                </div>
            </div>
            <div class="glass-panel p-6">
                <h3 class="font-bold mb-4">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
                <canvas id="tripsChart" height="80"></canvas>
            </div>
        </div>

        <div id="page-operations" class="page-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h2>
                <div class="flex gap-2">
                    <input type="text" id="ops-search" onkeyup="filterOperations()" placeholder="Ø¨Ø­Ø« (Ø§Ø³Ù…ØŒ Ù‡Ø§ØªÙØŒ ØªØ§Ø±ÙŠØ®)..." class="p-2 border rounded-lg text-sm w-64 outline-none focus:border-amber-500">
                    <button onclick="filterTomorrow()" class="bg-purple-100 text-purple-700 px-3 py-1 rounded text-xs font-bold hover:bg-purple-200">Ø±Ø­Ù„Ø§Øª Ø§Ù„ØºØ¯</button>
                    <button onclick="loadOperations()" class="bg-white border px-3 py-1 rounded shadow-sm text-sm hover:bg-slate-50"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
            <div class="glass-panel overflow-hidden">
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-100 text-slate-600 font-bold">
                        <tr>
                            <th class="p-4">#</th>
                            <th class="p-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th class="p-4">Ø§Ù„Ù…Ø³Ø§Ø±</th>
                            <th class="p-4">Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</th>
                            <th class="p-4">Ø§Ù„Ø³Ø¹Ø±</th>
                            <th class="p-4">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="p-4">Ø§Ù„ØªØ­ÙƒÙ…</th>
                        </tr>
                    </thead>
                    <tbody id="ops-table" class="divide-y divide-slate-100 font-medium"></tbody>
                </table>
            </div>
        </div>

        <div id="page-accounting" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="glass-panel p-6 border-t-4 border-red-500">
                    <h3 class="font-bold mb-4 text-red-600">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø¹Ø§Ù…</h3>
                    <div class="space-y-3">
                        <input type="text" id="exp-title" placeholder="Ø¨Ù†Ø¯ Ø§Ù„ØµØ±Ù (Ù…Ø«Ø§Ù„: Ø¥ÙŠØ¬Ø§Ø± Ù…ÙƒØªØ¨)" class="w-full p-2 border rounded text-sm">
                        <input type="number" id="exp-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="w-full p-2 border rounded text-sm">
                        <select id="exp-category" class="w-full p-2 border rounded text-sm bg-white">
                            <option>ØªØ´ØºÙŠÙ„</option><option>ØªØ³ÙˆÙŠÙ‚</option><option>Ø±ÙˆØ§ØªØ¨ Ø¥Ø¯Ø§Ø±ÙŠØ©</option><option>Ù†Ø«Ø±ÙŠØ§Øª</option>
                        </select>
                        <button onclick="addGeneralExpense()" class="w-full bg-red-600 text-white py-2 rounded text-sm font-bold hover:bg-red-700">ØªØ³Ø¬ÙŠÙ„</button>
                    </div>
                </div>
                <div class="col-span-2 glass-panel p-6 border-t-4 border-green-500">
                    <h3 class="font-bold mb-4 text-green-600">ØªØ­ØµÙŠÙ„Ø§Øª (InstaPay)</h3>
                    <div id="finance-pending-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
             <div class="glass-panel p-6">
                <h3 class="font-bold mb-4">Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ø®Ø²ÙŠÙ†Ø© (Ledger)</h3>
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-50"><tr><th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-3">Ø§Ù„Ù†ÙˆØ¹</th><th class="p-3">Ø§Ù„Ø¨ÙŠØ§Ù†</th><th class="p-3">Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                    <tbody id="treasury-log">
                        <tr><td colspan="4" class="text-center p-3 text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø­Ø¯ÙŠØ«Ø©</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="page-fleet" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-150px)]">
                <div class="glass-panel p-6 overflow-y-auto">
                    <div class="flex justify-between mb-4 border-b pb-2">
                        <h3 class="font-bold">Ø§Ù„ÙƒØ¨Ø§ØªÙ† ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h3>
                        <div class="flex gap-2">
                            <button onclick="addDriverPrompt()" class="text-blue-600 text-xs font-bold border px-2 py-1 rounded hover:bg-blue-50">+ ÙƒØ§Ø¨ØªÙ†</button>
                            <button onclick="addCarPrompt()" class="text-amber-600 text-xs font-bold border px-2 py-1 rounded hover:bg-amber-50">+ Ø³ÙŠØ§Ø±Ø©</button>
                        </div>
                    </div>
                    <div id="fleet-list" class="space-y-2"></div>
                </div>
                <div class="glass-panel p-6 overflow-y-auto" id="fleet-ledger-view">
                    <div class="flex flex-col items-center justify-center h-full text-slate-400">
                        <i class="fas fa-file-invoice-dollar text-6xl mb-4 text-slate-200"></i>
                        <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ÙƒØ§Ø¨ØªÙ† Ø£Ùˆ Ø³ÙŠØ§Ø±Ø© Ù„Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-coupons" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-panel p-6">
                    <h3 class="font-bold mb-4 text-pink-600">Ø¥ØµØ¯Ø§Ø± ÙƒÙˆØ¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h3>
                    <div class="space-y-3">
                        <input type="text" id="coupon-code" placeholder="Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø«Ø§Ù„: SAVE20)" class="w-full p-2 border rounded text-sm uppercase">
                        <input type="number" id="coupon-amount" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… (Ø¬Ù†ÙŠØ©)" class="w-full p-2 border rounded text-sm">
                        <button onclick="createCoupon()" class="w-full bg-pink-600 text-white py-2 rounded text-sm font-bold hover:bg-pink-700">Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</button>
                    </div>
                </div>
                <div class="col-span-2 glass-panel p-6">
                    <h3 class="font-bold mb-4">Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                    <div id="coupons-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
        
         <div id="page-crm" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]">
                <div class="glass-panel p-4 overflow-y-auto">
                    <input type="text" id="crm-search" onkeyup="filterCRM()" placeholder="Ø¨Ø­Ø«..." class="w-full p-3 border rounded-lg bg-slate-50 mb-4 outline-none focus:border-purple-500">
                    <div id="crm-users-list" class="space-y-2"></div>
                </div>
                <div class="col-span-2 glass-panel p-6 overflow-y-auto" id="crm-detail-view">
                    <div class="flex flex-col items-center justify-center h-full text-slate-400">
                        <i class="fas fa-id-card-alt text-6xl mb-4 text-slate-200"></i>
                        <p>Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙƒØ§Ù…Ù„</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-pricing" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ±</h2>
            <div class="glass-panel p-6" id="pricing-container">
                <div id="pricing-list" class="space-y-2 mb-4"></div>
                <button onclick="addPricingRule()" class="bg-slate-800 text-white w-full py-2 rounded">Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
        </div>

    </main>

    <div id="assign-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl w-[500px] shadow-2xl animate-fade-in-up">
            <h3 class="text-xl font-bold mb-4 text-slate-800 border-b pb-2">Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù…Ø©</h3>
            <input type="hidden" id="op-trip-id">
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500">Ø§Ù„ÙƒØ§Ø¨ØªÙ†</label><select id="op-driver" class="w-full p-2 border rounded bg-slate-50"></select></div>
                <div><label class="text-xs font-bold text-slate-500">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label><select id="op-car" class="w-full p-2 border rounded bg-slate-50"></select></div>
                <div><label class="text-xs font-bold text-slate-500">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="op-note" class="w-full p-2 border rounded h-20" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¹Ù‡ Ø­Ù‚Ø§Ø¦Ø¨ ÙƒØ«ÙŠØ±Ø©"></textarea></div>
                <div class="flex gap-2">
                    <button onclick="confirmOperation()" class="flex-1 bg-slate-900 text-white py-2 rounded font-bold hover:bg-slate-800">ØªØ£ÙƒÙŠØ¯</button>
                    <button onclick="document.getElementById('assign-modal').style.display='none'" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded hover:bg-slate-300">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://qxtlsfmfetwcflbpvwuf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4dGxzZm1mZXR3Y2ZsYnB2d3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzMzODEsImV4cCI6MjA3ODAwOTM4MX0.FFGXNfx0FDA4FmJB1gVorNigs9nRoO4q1pCj2BOMDbU';
        const sbClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Init
        initDashboard();

        function initDashboard() {
            renderCharts();
            loadKPIs();
            loadOperations();
            loadFinance();
            loadFleet();
            loadCRM();
            loadPricingTable();
            loadCoupons();
        }

        function showPage(id) {
            document.querySelectorAll('.page-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`page-${id}`).classList.remove('hidden');
            document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`nav-${id}`).classList.add('active');
            
            if(id === 'operations') loadOperations();
            if(id === 'finance') loadFinance();
            if(id === 'fleet') loadFleet();
            if(id === 'crm') loadCRM();
        }

        // --- 1. OPERATIONS (Advanced with Filters) ---
        let allTrips = []; 

        async function loadOperations() {
            const tbody = document.getElementById('ops-table');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';

            const { data: trips, error } = await sbClient
                .from('trips')
                .select('*, profiles:user_id(*), drivers:driver_id(*), cars:car_id(*)')
                .order('created_at', { ascending: false });

            if (error) { console.error(error); return; }

            allTrips = trips; 
            renderTripsTable(trips);
            updateBadge(trips);
        }

        function renderTripsTable(trips) {
            const tbody = document.getElementById('ops-table');
            tbody.innerHTML = '';
            
            if(!trips.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-6 text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª</td></tr>';
                return;
            }

            trips.forEach(t => {
                const clientName = t.profiles?.full_name || t.profiles?.name || 'Ø¶ÙŠÙ';
                const clientPhone = t.profiles?.phone || t.profiles?.phone_number || '---';
                const driverName = t.drivers?.name || '-';
                
                let statusBadge = t.status === 'pending' ? '<span class="status-badge bg-amber-100 text-amber-700">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>' 
                    : (t.status === 'approved' ? '<span class="status-badge bg-blue-100 text-blue-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</span>' 
                    : '<span class="status-badge bg-green-100 text-green-700">Ù…Ù†ØªÙ‡ÙŠ</span>');

                if(t.status === 'cancelled') statusBadge = '<span class="status-badge bg-red-100 text-red-700">Ù…Ù„ØºØ§Ø©</span>';

                let action = '';
                if(t.status === 'pending') action = `<button onclick="openAssignModal('${t.id}')" class="bg-slate-900 text-white px-3 py-1 rounded text-xs shadow">ØªØ¹ÙŠÙŠÙ†</button>`;
                if(t.status !== 'cancelled' && t.status !== 'completed') action += ` <button onclick="cancelTrip('${t.id}')" class="text-red-500 text-xs underline mr-2">Ø¥Ù„ØºØ§Ø¡</button>`;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b border-slate-100">
                        <td class="p-4 text-xs">#${t.id.slice(0,6)}</td>
                        <td class="p-4">
                            <div class="font-bold text-sm">${clientName}</div>
                            <div class="text-xs text-blue-500 dir-ltr text-right cursor-pointer" onclick="window.open('https://wa.me/${clientPhone}')">${clientPhone} <i class="fab fa-whatsapp"></i></div>
                        </td>
                        <td class="p-4 text-xs">${t.pickup_location.split(',')[0]} â ${t.dropoff_location.split(',')[0]}</td>
                        <td class="p-4 text-xs font-bold">${t.status === 'approved' ? t.cars?.model : t.car_type}</td>
                        <td class="p-4 font-bold text-green-700">${t.estimated_price}</td>
                        <td class="p-4">${statusBadge}</td>
                        <td class="p-4">${action}</td>
                    </tr>
                `;
            });
        }

        function filterOperations() {
            const q = document.getElementById('ops-search').value.toLowerCase();
            const filtered = allTrips.filter(t => 
                (t.profiles?.full_name || '').toLowerCase().includes(q) || 
                (t.profiles?.phone || '').includes(q) ||
                t.created_at.includes(q)
            );
            renderTripsTable(filtered);
        }

        function filterTomorrow() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];
            const filtered = allTrips.filter(t => t.admin_notes && t.admin_notes.includes(dateStr));
            renderTripsTable(filtered);
        }

        async function cancelTrip(id) {
            if(!confirm("Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) return;
            await sbClient.from('trips').update({status: 'cancelled'}).eq('id', id);
            loadOperations();
        }

        // --- 2. ASSIGNMENT (FIXED FK ERROR) ---
        async function openAssignModal(tripId) {
            document.getElementById('op-trip-id').value = tripId;
            document.getElementById('assign-modal').style.display = 'flex';
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ¨Ø§ØªÙ† (Active only)
            const { data: drivers } = await sbClient.from('drivers').select('id, name, phone').eq('status', 'active');
            const { data: cars } = await sbClient.from('cars').select('id, brand, model, plate_number').eq('status', 'active');
            
            const drSelect = document.getElementById('op-driver');
            drSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙƒØ§Ø¨ØªÙ† --</option>';
            if(drivers) drivers.forEach(d => drSelect.innerHTML += `<option value="${d.id}">${d.name} (${d.phone})</option>`);

            const carSelect = document.getElementById('op-car');
            carSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø© --</option>';
            if(cars) cars.forEach(c => carSelect.innerHTML += `<option value="${c.id}">${c.brand} ${c.model} (${c.plate_number})</option>`);
        }

        async function confirmOperation() {
            const tripId = document.getElementById('op-trip-id').value;
            const driverId = document.getElementById('op-driver').value;
            const carId = document.getElementById('op-car').value;
            const note = document.getElementById('op-note').value;

            if(!driverId || !carId) return alert("â›” ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ÙƒØ§Ø¨ØªÙ† ÙˆØ³ÙŠØ§Ø±Ø©");

            const { error } = await sbClient.from('trips').update({
                driver_id: driverId, car_id: carId, admin_notes: note, status: 'approved'
            }).eq('id', tripId);

            if(!error) {
                alert("âœ… ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†");
                document.getElementById('assign-modal').style.display = 'none';
                loadOperations(); 
            } else { alert(error.message); }
        }

        // --- 3. FLEET LEDGERS ---
        async function loadFleet() {
            const { data: drivers } = await sbClient.from('drivers').select('*');
            const { data: cars } = await sbClient.from('cars').select('*');
            
            let html = '<h4 class="font-bold mb-2 text-slate-500 text-xs">Ø§Ù„ÙƒØ¨Ø§ØªÙ†</h4>';
            if(drivers) {
                html += drivers.map(d => `
                    <div onclick="openLedger('driver', '${d.id}', '${d.name}')" class="flex justify-between items-center bg-white border p-3 rounded cursor-pointer hover:bg-slate-50 mb-2">
                        <div><p class="font-bold text-sm">${d.name}</p></div>
                        <span class="text-xs bg-slate-100 px-2 rounded">Ù…Ù„Ù ></span>
                    </div>
                `).join('');
            }
            
            html += '<h4 class="font-bold mb-2 mt-4 text-slate-500 text-xs">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h4>';
            if(cars) {
                html += cars.map(c => `
                    <div onclick="openLedger('car', '${c.id}', '${c.brand} ${c.plate_number}')" class="flex justify-between items-center bg-white border p-3 rounded cursor-pointer hover:bg-slate-50 mb-2">
                        <div><p class="font-bold text-sm">${c.brand}</p><p class="text-[10px] text-slate-400">${c.plate_number}</p></div>
                        <span class="text-xs bg-slate-100 px-2 rounded">Ù…Ù„Ù ></span>
                    </div>
                `).join('');
            }
            document.getElementById('fleet-list').innerHTML = html;
        }

        async function openLedger(type, id, name) {
            const view = document.getElementById('fleet-ledger-view');
            view.innerHTML = `<h3 class="font-bold text-xl mb-4 border-b pb-2">ğŸ“‚ Ù…Ù„Ù: ${name}</h3><p class="text-slate-400 text-sm">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...</p>`;
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø­ÙŠÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ expenses
            setTimeout(() => {
                view.innerHTML = `
                    <h3 class="font-bold text-xl mb-4 border-b pb-2">ğŸ“‚ Ù…Ù„Ù: ${name}</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-green-50 p-3 rounded text-center"><p class="text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„</p><p class="font-bold text-green-700">0.00</p></div>
                        <div class="bg-red-50 p-3 rounded text-center"><p class="text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p><p class="font-bold text-red-700">0.00</p></div>
                    </div>
                    <div class="text-center mt-10 text-slate-400"><i class="fas fa-file-invoice text-4xl mb-2"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø©</div>
                `;
            }, 500);
        }

        // --- 4. COUPONS ---
        async function loadCoupons() {
            // Ù…Ø­Ø§ÙƒØ§Ø©
            const list = document.getElementById('coupons-list');
            list.innerHTML = `
                <div class="flex justify-between bg-pink-50 border border-pink-200 p-3 rounded text-sm items-center">
                    <div><span class="font-bold text-pink-700">WELCOME10</span> <span class="text-xs text-slate-500">(10%)</span></div>
                    <span class="bg-green-200 text-green-800 text-[10px] px-2 rounded">Ù†Ø´Ø·</span>
                </div>
            `;
        }
        async function createCoupon() {
            alert("Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† (ÙŠØªØ·Ù„Ø¨ Ø¬Ø¯ÙˆÙ„ coupons)");
        }

        // --- 5. FINANCE & ACCOUNTING ---
        async function loadFinance() {
            const { data: pending } = await sbClient.from('transactions').select('*, profiles:user_id(*)').eq('status', 'pending');
            const list = document.getElementById('finance-pending-list');
            list.innerHTML = '';
            
            if(pending && pending.length > 0) {
                pending.forEach(tx => {
                    list.innerHTML += `
                        <div class="bg-white border p-2 rounded flex justify-between items-center text-sm mb-2">
                            <div><span class="font-bold text-green-600">+${tx.amount}</span> <span class="text-xs text-slate-500">${tx.profiles?.full_name}</span></div>
                            <button onclick="approveTx('${tx.id}', '${tx.user_id}', ${tx.amount})" class="bg-green-500 text-white px-2 rounded text-xs">âœ”</button>
                        </div>
                    `;
                });
            } else { list.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>'; }
        }

        async function approveTx(id, uid, amount) {
            await sbClient.from('transactions').update({status:'approved'}).eq('id', id);
            const {data} = await sbClient.from('profiles').select('wallet_balance').eq('id', uid).single();
            await sbClient.from('profiles').update({wallet_balance: (data.wallet_balance||0) + Number(amount)}).eq('id', uid);
            loadFinance();
        }

        async function addGeneralExpense() {
            alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙÙŠ Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©");
        }

        // --- 6. KPI ---
        function updateBadge(trips) {
            const pendingCount = trips.filter(t => t.status === 'pending').length;
            const badge = document.getElementById('pending-badge');
            badge.innerText = pendingCount;
            if(pendingCount > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
            
            document.getElementById('kpi-total-trips').innerText = trips.length;
            document.getElementById('kpi-pending').innerText = pendingCount;
        }
        
        async function loadKPIs() { /* Handled in loadOperations */ }

        // --- 7. Others ---
        async function loadPricingTable() { 
            const { data } = await sbClient.from('pricing_rules').select('*');
            document.getElementById('pricing-list').innerHTML = data.map(r => `<div class="bg-white p-2 border rounded text-xs flex justify-between"><span>${r.car_type}</span><span>${r.price_per_km}</span></div>`).join('');
        }
        async function loadCRM() { /* Basic implementation */ }
        async function addDriverPrompt() {
             const n = prompt("Ø§Ù„Ø§Ø³Ù…:"); const p = prompt("Ø§Ù„Ù‡Ø§ØªÙ:");
             if(n) { await sbClient.from('drivers').insert([{name:n, phone:p, status:'active'}]); loadFleet(); }
        }
        async function addCarPrompt() {
             const b = prompt("Ø§Ù„Ù…Ø§Ø±ÙƒØ©:"); const p = prompt("Ø§Ù„Ù„ÙˆØ­Ø©:");
             if(b) { await sbClient.from('cars').insert([{brand:b, plate_number:p, type:'sedan', status:'active'}]); loadFleet(); }
        }

        // Helpers
        function renderCharts() {
            new Chart(document.getElementById('tripsChart'), { type: 'line', data: { labels: ['S', 'M', 'T', 'W', 'T', 'F', 'S'], datasets: [{ label: 'Ø§Ù„Ø±Ø­Ù„Ø§Øª', data: [12, 19, 3, 5, 2, 3, 10], borderColor: '#3b82f6' }] } });
        }

        // Auto Refresh
        setInterval(() => {
            if(!document.getElementById('page-operations').classList.contains('hidden')) loadOperations();
            loadFinance();
        }, 15000);

    </script>
</body>
</html>