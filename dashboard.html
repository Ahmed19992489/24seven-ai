<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24Seven | ERP System Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .sidebar-item { transition: all 0.2s; cursor: pointer; border-right: 3px solid transparent; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #e2e8f0; color: #0f172a; font-weight: bold; border-right-color: #f59e0b; }
        .glass-panel { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
        .input-std { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.9rem; outline: none; }
        .input-std:focus { border-color: #f59e0b; ring: 2px solid #fcd34d; }
        .btn-action { transition: transform 0.1s; } .btn-action:active { transform: scale(0.95); }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800">

    <aside class="w-64 bg-white border-l border-slate-200 flex flex-col z-20 shadow-lg shrink-0">
        <div class="h-16 flex items-center justify-center border-b border-slate-100 bg-slate-900 text-white">
            <h1 class="text-xl font-black">24<span class="text-amber-500">Seven</span> <span class="text-[10px] font-normal text-slate-400">ERP</span></h1>
        </div>
        
        <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
            <div onclick="showPage('dashboard')" id="nav-dashboard" class="sidebar-item active p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-chart-line w-5 text-center text-blue-600"></i> لوحة القيادة
            </div>
            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">إدارة العمليات</p>
            <div onclick="showPage('operations')" id="nav-operations" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-satellite-dish w-5 text-center text-amber-600"></i> غرفة العمليات
            </div>
            <div onclick="showPage('crm')" id="nav-crm" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-users w-5 text-center text-purple-600"></i> العملاء (CRM)
            </div>
            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">المالية والموارد</p>
            <div onclick="showPage('finance')" id="nav-finance" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-wallet w-5 text-center text-green-600"></i> الخزينة والمحافظ
            </div>
            <div onclick="showPage('fleet')" id="nav-fleet" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-car w-5 text-center text-slate-600"></i> السيارات والكباتن
            </div>
            <p class="text-[10px] font-bold text-slate-400 mt-4 mb-1 px-3">الإعدادات</p>
            <div onclick="showPage('pricing')" id="nav-pricing" class="sidebar-item p-3 rounded-lg flex items-center gap-3">
                <i class="fas fa-tags w-5 text-center text-gray-600"></i> التسعير
            </div>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-6 relative bg-[#f8fafc]">
        
        <div id="page-dashboard" class="page-section">
            <h2 class="text-2xl font-bold mb-6">نظرة عامة</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-panel p-6 border-b-4 border-blue-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">إجمالي الرحلات</p>
                    <h3 class="text-3xl font-black mt-2" id="kpi-total">--</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-green-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">الخزينة الرئيسية</p>
                    <h3 class="text-3xl font-black mt-2 text-green-600 dir-ltr" id="kpi-main-vault">0 EGP</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-amber-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">خزنة الصيانة</p>
                    <h3 class="text-3xl font-black mt-2 text-amber-600 dir-ltr" id="kpi-maint-vault">0 EGP</h3>
                </div>
                <div class="glass-panel p-6 border-b-4 border-purple-500">
                    <p class="text-slate-400 text-xs font-bold uppercase">مدفوعات رواتب السيارات</p>
                    <h3 class="text-3xl font-black mt-2 text-purple-600 dir-ltr" id="kpi-cars-salary">0 EGP</h3>
                </div>
            </div>
            <div class="glass-panel p-6">
                <h3 class="font-bold mb-4">أداء الأسبوع</h3>
                <canvas id="tripsChart" height="70"></canvas>
            </div>
        </div>

        <div id="page-operations" class="page-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">غرفة العمليات المركزية</h2>
                <button onclick="loadOperations()" class="bg-white border px-4 py-2 rounded-lg hover:bg-slate-100 font-bold text-sm"><i class="fas fa-sync-alt mr-2"></i> تحديث البيانات</button>
            </div>
            <div class="glass-panel overflow-hidden">
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-100 text-slate-600 font-bold">
                        <tr>
                            <th class="p-4">#</th>
                            <th class="p-4">العميل</th>
                            <th class="p-4">المسار</th>
                            <th class="p-4">المركبة/الكابتن</th>
                            <th class="p-4">السعر</th>
                            <th class="p-4">الحالة</th>
                            <th class="p-4">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="ops-table" class="divide-y divide-slate-100 font-medium"></tbody>
                </table>
            </div>
        </div>

        <div id="page-finance" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">الإدارة المالية والخزن</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="vaults-grid"></div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-panel p-6">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-money-bill-wave text-green-500"></i> طلبات شحن المحفظة (InstaPay)
                    </h3>
                    <div id="deposit-requests-list" class="space-y-3 max-h-80 overflow-y-auto">
                        <p class="text-center text-slate-400 py-4">جاري التحميل...</p>
                    </div>
                </div>

                <div class="glass-panel p-6 border-t-4 border-red-500">
                    <h3 class="font-bold mb-4 text-red-600">تسجيل مصروف إداري (عام)</h3>
                    <div class="space-y-3">
                        <input type="text" id="gen-exp-title" placeholder="بند الصرف (مثال: إيجار، كهرباء)" class="input-std">
                        <div class="flex gap-2">
                            <input type="number" id="gen-exp-amount" placeholder="المبلغ" class="input-std">
                            <select id="gen-exp-vault" class="input-std bg-slate-50">
                                <option value="main">من الخزينة الرئيسية</option>
                            </select>
                        </div>
                        <button onclick="addGeneralExpense()" class="w-full bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 btn-action">تسجيل وخصم</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-fleet" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">إدارة الأسطول (سيارات وكباتن)</h2>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[calc(100vh-150px)]">
                
                <div class="glass-panel p-4 overflow-y-auto col-span-1">
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2 px-1">
                            <h4 class="font-bold text-slate-600 text-xs uppercase">السيارات</h4>
                            <button onclick="addCarPrompt()" class="text-[10px] bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded">إضافة</button>
                        </div>
                        <div id="fleet-cars-list" class="space-y-2"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2 px-1">
                            <h4 class="font-bold text-slate-600 text-xs uppercase">الكباتن</h4>
                            <button onclick="addDriverPrompt()" class="text-[10px] bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded">إضافة</button>
                        </div>
                        <div id="fleet-drivers-list" class="space-y-2"></div>
                    </div>
                </div>

                <div class="glass-panel p-6 col-span-3 overflow-y-auto bg-slate-50 relative" id="ledger-view">
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 opacity-50">
                        <i class="fas fa-folder-open text-6xl mb-4"></i>
                        <p>اختر عنصراً من القائمة لعرض الملف المالي</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-crm" class="page-section hidden">
            <h2 class="text-2xl font-bold mb-6">سجل العملاء والمحافظ</h2>
            <div class="glass-panel overflow-hidden">
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-4">العميل</th>
                            <th class="p-4">رقم الهاتف</th>
                            <th class="p-4">رصيد المحفظة</th>
                            <th class="p-4">تاريخ التسجيل</th>
                        </tr>
                    </thead>
                    <tbody id="crm-table"></tbody>
                </table>
            </div>
        </div>
        
        <div id="page-pricing" class="page-section hidden">
            <div class="glass-panel p-6 max-w-2xl mx-auto">
                <h3 class="font-bold mb-4">شرائح التسعير</h3>
                <div id="pricing-list" class="space-y-2 mb-6"></div>
                
                <h4 class="font-bold text-sm mb-2 mt-6 pt-4 border-t">إضافة شريحة جديدة</h4>
                <div class="grid grid-cols-5 gap-2 items-end">
                    <select id="rule-type" class="input-std"><option value="sedan">Sedan</option><option value="suv">SUV</option><option value="van">Van</option></select>
                    <input type="number" id="rule-min" placeholder="من كم" class="input-std">
                    <input type="number" id="rule-max" placeholder="إلى كم" class="input-std">
                    <input type="number" id="rule-base" placeholder="فتح" class="input-std">
                    <input type="number" id="rule-km" placeholder="سعر الكيلو" class="input-std">
                </div>
                <button onclick="addPricingTier()" class="w-full mt-4 bg-slate-900 text-white py-2 rounded-lg font-bold">حفظ</button>
            </div>
        </div>

    </main>

    <div id="assign-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-[500px] shadow-2xl">
            <h3 class="text-xl font-bold mb-4 border-b pb-3">تعيين كابتن وسيارة</h3>
            <input type="hidden" id="modal-trip-id">
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500">الكابتن</label><select id="modal-driver" class="input-std"></select></div>
                <div><label class="text-xs font-bold text-slate-500">السيارة</label><select id="modal-car" class="input-std"></select></div>
                <div><label class="text-xs font-bold text-slate-500">ملاحظات</label><textarea id="modal-note" class="input-std h-20"></textarea></div>
                <div class="flex gap-2 pt-2">
                    <button onclick="confirmAssign()" class="flex-1 bg-slate-900 text-white py-2.5 rounded-lg font-bold">تأكيد التعيين</button>
                    <button onclick="document.getElementById('assign-modal').style.display='none'" class="flex-1 bg-slate-200 text-slate-700 py-2.5 rounded-lg font-bold">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <div id="complete-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-[400px] shadow-2xl border-t-4 border-green-600">
            <h3 class="text-xl font-bold mb-4 text-green-700 border-b pb-3">تصفية وإنهاء الرحلة</h3>
            <input type="hidden" id="comp-trip-id">
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500">إجمالي الإيراد (من العميل)</label>
                    <input type="number" id="comp-price" class="input-std font-bold text-green-600" placeholder="0">
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-xs font-bold text-slate-500">يومية الكابتن</label>
                        <input type="number" id="comp-wage" class="input-std font-bold text-red-600" value="0">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs font-bold text-slate-500">بنزين / كارتة</label>
                        <input type="number" id="comp-fuel" class="input-std font-bold text-amber-600" value="0">
                    </div>
                </div>
                <p class="text-[10px] text-slate-400">* سيتم إضافة الصافي للخزينة الرئيسية، وتسجيل اليومية والمصاريف تلقائياً.</p>
                <div class="flex gap-2 pt-2">
                    <button onclick="confirmComplete()" class="flex-1 bg-green-600 text-white py-2.5 rounded-lg font-bold hover:bg-green-700">تأكيد وحفظ</button>
                    <button onclick="document.getElementById('complete-modal').style.display='none'" class="flex-1 bg-slate-200 text-slate-700 py-2.5 rounded-lg font-bold">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <div id="expense-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-[500px] shadow-2xl">
            <h3 class="text-xl font-bold mb-4 border-b pb-3 text-red-600">تسجيل حركة مالية</h3>
            <input type="hidden" id="exp-target-id"> <input type="hidden" id="exp-target-type"> 
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500">البيان</label><input type="text" id="exp-modal-title" placeholder="مثال: سلفة، صيانة، غسيل" class="input-std"></div>
                <div><label class="text-xs font-bold text-slate-500">المبلغ</label><input type="number" id="exp-modal-amount" class="input-std"></div>
                <div>
                    <label class="text-xs font-bold text-slate-500">الخزنة المسحوب منها</label>
                    <select id="exp-modal-vault" class="input-std bg-slate-50"><option value="main">الخزينة الرئيسية</option></select>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="confirmExpense()" class="flex-1 bg-red-600 text-white py-2.5 rounded-lg font-bold hover:bg-red-700">تأكيد الخصم</button>
                    <button onclick="document.getElementById('expense-modal').style.display='none'" class="flex-1 bg-slate-200 text-slate-700 py-2.5 rounded-lg font-bold">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://qxtlsfmfetwcflbpvwuf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4dGxzZm1mZXR3Y2ZsYnB2d3VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzMzODEsImV4cCI6MjA3ODAwOTM4MX0.FFGXNfx0FDA4FmJB1gVorNigs9nRoO4q1pCj2BOMDbU';
        const sbClient = supabase.createClient(supabaseUrl, supabaseKey);

        showPage('dashboard');

        // --- Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.querySelectorAll('.sidebar-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
            if(pageId === 'dashboard') loadDashboard();
            if(pageId === 'operations') loadOperations();
            if(pageId === 'crm') loadCRM();
            if(pageId === 'finance') loadFinance();
            if(pageId === 'fleet') loadFleetList();
            if(pageId === 'pricing') loadPricing();
        }

        // --- 1. Dashboard ---
        async function loadDashboard() {
            const { count } = await sbClient.from('trips').select('*', { count: 'exact', head: true });
            document.getElementById('kpi-total').innerText = count || 0;
            const { data: vaults } = await sbClient.from('vaults').select('*');
            if(vaults) {
                const main = vaults.find(v => v.name === 'الخزينة الرئيسية') || {balance:0};
                const maint = vaults.find(v => v.name === 'خزنة الصيانة') || {balance:0};
                const cars = vaults.find(v => v.name === 'خزنة رواتب السيارات') || {balance:0};
                document.getElementById('kpi-main-vault').innerText = `${main.balance} EGP`;
                document.getElementById('kpi-maint-vault').innerText = `${maint.balance} EGP`;
                document.getElementById('kpi-cars-salary').innerText = `${cars.balance} EGP`;
            }
        }

        // --- 2. Operations ---
        async function loadOperations() {
            const list = document.getElementById('ops-table');
            list.innerHTML = '<tr><td colspan="7" class="text-center p-4">جاري التحميل...</td></tr>';
            const { data: trips } = await sbClient.from('trips').select(`*, cars(brand, model), drivers(name)`).order('created_at', { ascending: false });
            
            // Fix: User names mapping
            const userIds = trips?.map(t => t.user_id).filter(Boolean) || [];
            let profilesMap = {};
            if(userIds.length) {
                const {data: profiles} = await sbClient.from('profiles').select('id, full_name').in('id', userIds);
                if(profiles) profiles.forEach(p => profilesMap[p.id] = p.full_name);
            }

            list.innerHTML = '';
            if(!trips?.length) { list.innerHTML = '<tr><td colspan="7" class="text-center p-4">لا توجد رحلات</td></tr>'; return; }

            trips.forEach(t => {
                const clientName = profilesMap[t.user_id] || 'عميل';
                const statusColor = t.status === 'pending' ? 'bg-amber-100 text-amber-800' : (t.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800');
                let btns = '';
                if(t.status === 'pending') btns = `<button onclick="openAssignModal('${t.id}')" class="bg-slate-900 text-white px-3 py-1 rounded text-xs">تعيين</button>`;
                else if(t.status === 'approved') btns = `<button onclick="openCompleteModal('${t.id}', ${t.estimated_price})" class="bg-green-600 text-white px-3 py-1 rounded text-xs">إنهاء</button>`;

                list.innerHTML += `<tr class="border-b hover:bg-white"><td class="p-4">#${t.id.slice(0,6)}</td><td class="p-4 font-bold text-sm">${clientName}</td><td class="p-4 text-xs text-slate-500">${t.pickup_location.split(',')[0]} ➝ ${t.dropoff_location.split(',')[0]}</td><td class="p-4 text-xs font-bold">${t.drivers ? t.drivers.name : '-'} / ${t.cars ? t.cars.brand : '-'}</td><td class="p-4 font-bold text-green-700">${t.estimated_price}</td><td class="p-4"><span class="px-2 py-1 rounded text-[10px] ${statusColor}">${t.status}</span></td><td class="p-4">${btns}</td></tr>`;
            });
        }

        // --- Trip Completion (The Core Logic) ---
        function openCompleteModal(tripId, price) {
            document.getElementById('comp-trip-id').value = tripId;
            document.getElementById('comp-price').value = price;
            document.getElementById('comp-wage').value = 0;
            document.getElementById('comp-fuel').value = 0;
            document.getElementById('complete-modal').style.display = 'flex';
        }

        async function confirmComplete() {
            const tripId = document.getElementById('comp-trip-id').value;
            const price = Number(document.getElementById('comp-price').value);
            const wage = Number(document.getElementById('comp-wage').value);
            const fuel = Number(document.getElementById('comp-fuel').value);

            // 1. حساب الصافي (Net to Vault)
            const netToVault = price - wage - fuel;

            if(!confirm(`تأكيد الإنهاء؟\n\nالإيراد: ${price}\nيومية الكابتن: ${wage}\nمصروفات: ${fuel}\n\nصافي للخزنة: ${netToVault}`)) return;

            // 2. تحديث حالة الرحلة
            await sbClient.from('trips').update({ status: 'completed', final_price: price, driver_wage: wage }).eq('id', tripId);

            // 3. تحديث الخزينة الرئيسية بالصافي
            const vid = await getMainVaultId();
            const { data: v } = await sbClient.from('vaults').select('balance').eq('id', vid).single();
            await sbClient.from('vaults').update({ balance: (v.balance||0) + netToVault }).eq('id', vid);

            // 4. تسجيل الحركات في ملف الكابتن والسيارة
            const { data: trip } = await sbClient.from('trips').select('driver_id, car_id').eq('id', tripId).single();
            
            if(wage > 0 && trip.driver_id) {
                // نسجل اليومية كـ "إيراد" للكابتن في ملفه (أو مصروف مدفوع له)
                await sbClient.from('expenses').insert([{ title: `يومية رحلة #${tripId.slice(0,4)}`, amount: wage, category: 'يومية', related_driver_id: trip.driver_id }]);
            }
            if(fuel > 0 && trip.car_id) {
                // نسجل البنزين كمصروف على السيارة
                await sbClient.from('expenses').insert([{ title: `بنزين/كارتة رحلة #${tripId.slice(0,4)}`, amount: fuel, category: 'تشغيل', related_car_id: trip.car_id }]);
            }

            document.getElementById('complete-modal').style.display = 'none';
            loadOperations(); loadDashboard();
        }

        // --- 3. Finance ---
        async function loadFinance() {
            const { data: vaults } = await sbClient.from('vaults').select('*');
            const grid = document.getElementById('vaults-grid');
            const select = document.getElementById('gen-exp-vault');
            const modalSelect = document.getElementById('exp-modal-vault');
            
            grid.innerHTML = '';
            select.innerHTML = '<option value="main">الخزينة الرئيسية</option>';
            modalSelect.innerHTML = '<option value="main">الخزينة الرئيسية</option>';

            vaults.forEach(v => {
                grid.innerHTML += `<div class="glass-panel p-5 border-l-4 border-amber-500 flex justify-between items-center"><div><p class="text-xs font-bold text-slate-400 uppercase">${v.name}</p><h3 class="text-2xl font-black mt-1">${v.balance} <span class="text-sm font-normal">EGP</span></h3></div></div>`;
                if(v.name !== 'الخزينة الرئيسية') {
                    select.innerHTML += `<option value="${v.id}">${v.name}</option>`;
                    modalSelect.innerHTML += `<option value="${v.id}">${v.name}</option>`;
                }
            });
            // Deposit Requests
            const { data: reqs } = await sbClient.from('transactions').select('*, profiles(full_name)').eq('status', 'pending');
            document.getElementById('deposit-requests-list').innerHTML = reqs?.length ? reqs.map(r => `<div class="bg-white border rounded p-2 flex justify-between text-sm mb-2"><span>${r.profiles?.full_name} (${r.amount})</span><button onclick="processDeposit('${r.id}', '${r.user_id}', ${r.amount})" class="text-green-600 font-bold">قبول</button></div>`).join('') : '<p class="text-center text-xs text-slate-400">لا توجد طلبات</p>';
        }

        async function processDeposit(txId, userId, amount) {
            if(!confirm(`قبول ${amount}؟`)) return;
            await sbClient.from('transactions').update({ status: 'approved' }).eq('id', txId);
            const { data: p } = await sbClient.from('profiles').select('wallet_balance').eq('id', userId).single();
            await sbClient.from('profiles').update({ wallet_balance: (p.wallet_balance||0) + Number(amount) }).eq('id', userId);
            const vid = await getMainVaultId();
            const { data: v } = await sbClient.from('vaults').select('balance').eq('id', vid).single();
            await sbClient.from('vaults').update({ balance: (v.balance||0) + Number(amount) }).eq('id', vid);
            loadFinance();
        }

        async function addGeneralExpense() {
            const title = document.getElementById('gen-exp-title').value;
            const amount = document.getElementById('gen-exp-amount').value;
            const vaultId = document.getElementById('gen-exp-vault').value;
            if(!title || !amount) return alert("البيانات ناقصة");
            const vid = vaultId === 'main' ? (await getMainVaultId()) : vaultId;
            await sbClient.from('expenses').insert([{ title, amount, category: 'عام', related_vault_id: vid }]);
            const { data: v } = await sbClient.from('vaults').select('balance').eq('id', vid).single();
            await sbClient.from('vaults').update({ balance: (v.balance||0) - Number(amount) }).eq('id', vid);
            alert("تم تسجيل المصروف"); loadFinance();
        }

        async function getMainVaultId() {
            const { data } = await sbClient.from('vaults').select('id').eq('name', 'الخزينة الرئيسية').single();
            return data?.id;
        }

        // --- 4. Fleet ---
        async function loadFleetList() {
            const { data: cars } = await sbClient.from('cars').select('*');
            const { data: drivers } = await sbClient.from('drivers').select('*');
            document.getElementById('fleet-cars-list').innerHTML = cars.map(c => `<div onclick="openLedger('car', '${c.id}', '${c.brand} ${c.plate_number}', ${c.monthly_salary||0})" class="bg-white p-3 border rounded cursor-pointer hover:bg-slate-50 mb-2 font-bold flex justify-between"><span>${c.brand}</span><span>${c.plate_number}</span></div>`).join('');
            document.getElementById('fleet-drivers-list').innerHTML = drivers.map(d => `<div onclick="openLedger('driver', '${d.id}', '${d.name}')" class="bg-white p-3 border rounded cursor-pointer hover:bg-slate-50 mb-2 font-bold">${d.name}</div>`).join('');
        }

        async function openLedger(type, id, name, salary=0) {
            const view = document.getElementById('ledger-view');
            view.innerHTML = 'جاري التحميل...';
            
            let income = 0; let outcome = 0; let movements = [];
            const { data: exps } = await sbClient.from('expenses').select('*').eq(type === 'car' ? 'related_car_id' : 'related_driver_id', id);
            if(exps) exps.forEach(e => {
                // For Driver: If category is 'يومية' -> Income. Else -> Outcome (Advance/Deduction)
                if(type === 'driver' && e.category === 'يومية') {
                    income += e.amount;
                    movements.push({date: e.created_at, title: e.title, amount: e.amount, type: 'in'});
                } else {
                    outcome += e.amount;
                    movements.push({date: e.created_at, title: e.title, amount: -e.amount, type: 'out'});
                }
            });

            // Trip Revenue for Cars Only
            if(type === 'car') {
                const { data: trips } = await sbClient.from('trips').select('*').eq('car_id', id).eq('status', 'completed');
                if(trips) trips.forEach(t => {
                    income += t.final_price;
                    movements.push({date: t.created_at, title: `إيراد رحلة`, amount: t.final_price, type: 'in'});
                });
            }

            movements.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            let extraBtn = '';
            if(type === 'car') extraBtn = `<button onclick="payCarSalary('${id}', ${salary})" class="w-full bg-purple-600 text-white py-2 rounded mt-4">سداد راتب السيارة (${salary})</button>`;

            view.innerHTML = `
                <h3 class="font-bold text-xl mb-4 border-b pb-2">${name}</h3>
                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                    <div class="bg-green-50 p-2 rounded"><p class="text-xs">المستحق/الإيراد</p><p class="font-bold text-green-700">${income}</p></div>
                    <div class="bg-red-50 p-2 rounded"><p class="text-xs">المصروف/المسحوب</p><p class="font-bold text-red-700">${outcome}</p></div>
                    <div class="bg-slate-100 p-2 rounded"><p class="text-xs">الصافي</p><p class="font-bold">${income - outcome}</p></div>
                </div>
                <button onclick="openExpenseModal('${type}', '${id}')" class="w-full bg-red-600 text-white py-2 rounded mb-2">تسجيل حركة (خصم/سلفة)</button>
                ${extraBtn}
                <div class="mt-4 space-y-2 max-h-60 overflow-y-auto">
                    ${movements.map(m => `<div class="flex justify-between text-xs border-b pb-1"><span>${m.title}</span><span class="${m.type==='in'?'text-green-600':'text-red-600'}">${m.amount}</span></div>`).join('')}
                </div>
            `;
        }

        async function payCarSalary(carId, salary) {
            if(!confirm(`سداد ${salary}؟`)) return;
            const vid = await getMainVaultId();
            // 1. Record as expense on car
            await sbClient.from('expenses').insert([{ title: 'راتب شهري', amount: salary, category: 'رواتب سيارات', related_car_id: carId }]);
            // 2. Deduct from Main Vault
            const { data: v } = await sbClient.from('vaults').select('balance').eq('id', vid).single();
            await sbClient.from('vaults').update({ balance: (v.balance||0) - salary }).eq('id', vid);
            // 3. Add to "Car Salaries Vault" for tracking
            const { data: cv } = await sbClient.from('vaults').select('id, balance').eq('name', 'خزنة رواتب السيارات').single();
            if(cv) await sbClient.from('vaults').update({ balance: (cv.balance||0) + salary }).eq('id', cv.id);
            alert("تم السداد"); loadDashboard(); openLedger('car', carId, '...');
        }

        // --- 5. Expense Modal ---
        async function openExpenseModal(type, id) {
            document.getElementById('expense-modal').style.display = 'flex';
            document.getElementById('exp-target-type').value = type;
            document.getElementById('exp-target-id').value = id;
        }
        async function confirmExpense() {
            const type = document.getElementById('exp-target-type').value;
            const id = document.getElementById('exp-target-id').value;
            const title = document.getElementById('exp-modal-title').value;
            const amount = document.getElementById('exp-modal-amount').value;
            const vid = document.getElementById('exp-modal-vault').value;
            
            const vaultId = vid === 'main' ? (await getMainVaultId()) : vid;

            const insertData = { title, amount, category: 'يدوي', related_vault_id: vaultId };
            if(type === 'car') insertData.related_car_id = id;
            if(type === 'driver') insertData.related_driver_id = id;

            await sbClient.from('expenses').insert([insertData]);
            
            // Deduct from selected vault
            const { data: v } = await sbClient.from('vaults').select('balance').eq('id', vaultId).single();
            await sbClient.from('vaults').update({ balance: (v.balance||0) - amount }).eq('id', vaultId);
            
            document.getElementById('expense-modal').style.display = 'none';
            alert("تم"); openLedger(type, id, '...');
        }

        // --- Helpers ---
        async function loadCRM() {
            const list = document.getElementById('crm-table');
            const { data: profiles } = await sbClient.from('profiles').select('*');
            list.innerHTML = '';
            if(!profiles || profiles.length === 0) list.innerHTML = '<tr><td colspan="4" class="text-center p-4">لا يوجد عملاء</td></tr>';
            else profiles.forEach(p => {
                list.innerHTML += `<tr class="border-b bg-white"><td class="p-4 font-bold text-slate-700">${p.full_name||'-'}</td><td class="p-4 text-slate-500">${p.phone||'-'}</td><td class="p-4 font-bold ${p.wallet_balance<0?'text-red-500':'text-green-600'}">${p.wallet_balance||0}</td><td class="p-4 text-xs text-slate-400">${new Date(p.created_at).toLocaleDateString()}</td></tr>`;
            });
        }
        async function loadPricing() {
            const { data } = await sbClient.from('pricing_tiers').select('*');
            document.getElementById('pricing-list').innerHTML = data.map(r => `<div class="bg-white p-2 border rounded mb-2 flex justify-between"><span>${r.car_type}</span><span>${r.price_per_km}/km</span></div>`).join('');
        }
        async function addPricingTier() {
            const type = document.getElementById('rule-type').value, min = document.getElementById('rule-min').value, max = document.getElementById('rule-max').value, base = document.getElementById('rule-base').value, km = document.getElementById('rule-km').value;
            await sbClient.from('pricing_tiers').insert([{car_type:type, min_km:min, max_km:max, base_price:base, price_per_km:km}]);
            loadPricing();
        }
        async function openAssignModal(id) {
            document.getElementById('modal-trip-id').value = id;
            document.getElementById('assign-modal').style.display = 'flex';
            const { data: d } = await sbClient.from('drivers').select('*');
            const { data: c } = await sbClient.from('cars').select('*');
            const dSel = document.getElementById('modal-driver'); dSel.innerHTML=''; d.forEach(x=>dSel.innerHTML+=`<option value="${x.id}">${x.name}</option>`);
            const cSel = document.getElementById('modal-car'); cSel.innerHTML=''; c.forEach(x=>cSel.innerHTML+=`<option value="${x.id}">${x.brand}</option>`);
        }
        async function confirmAssign() {
            const tid = document.getElementById('modal-trip-id').value, did = document.getElementById('modal-driver').value, cid = document.getElementById('modal-car').value, note = document.getElementById('modal-note').value;
            await sbClient.from('trips').update({driver_id:did, car_id:cid, admin_notes:note, status:'approved'}).eq('id', tid);
            document.getElementById('assign-modal').style.display = 'none'; loadOperations();
        }
        async function addCarPrompt() {
            const b = prompt("الماركة:"); const p = prompt("اللوحة:"); const s = prompt("الراتب الشهري:");
            if(b) { await sbClient.from('cars').insert([{brand:b, plate_number:p, monthly_salary:s||0}]); loadFleetList(); }
        }
        async function addDriverPrompt() {
            const n = prompt("الاسم:"); const p = prompt("الهاتف:");
            if(n) { await sbClient.from('drivers').insert([{name:n, phone:p}]); loadFleetList(); }
        }

        new Chart(document.getElementById('tripsChart'), { type: 'bar', data: { labels: ['S', 'M', 'T', 'W', 'T', 'F', 'S'], datasets: [{ label: 'الرحلات', data: [5, 8, 12, 7, 15, 10, 9], backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } } } });
    </script>

    <!-- Vercel Speed Insights -->
    <script>
      window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>